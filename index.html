<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.1.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.1.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.1.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="Shuhan 同学的笔记">
<meta property="og:url" content="http://zsh-89.github.io/index.html">
<meta property="og:site_name" content="Shuhan 同学的笔记">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Shuhan 同学的笔记">






  <link rel="canonical" href="http://zsh-89.github.io/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Shuhan 同学的笔记</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> 

<div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Shuhan 同学的笔记</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
          
  
  <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
</li>

      
        
        
          
  
  <li class="menu-item menu-item-about menu-item-active">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />About</a>
</li>

      
        
        
          
  
  <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />Tags</a>
</li>

      
        
        
          
  
  <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
</li>

      

      
    </ul>
  

  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zsh-89.github.io/2018/04/08/C-同样算法-手写的循环不如直接写递归快/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shuhan 同学">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuhan 同学的笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/08/C-同样算法-手写的循环不如直接写递归快/" itemprop="url">C++, 同样算法, 手写的循环不如直接写递归快?</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-08T16:50:29+08:00">2018-04-08</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>起因是 leetcode 上的一道题 <a href="https://leetcode.com/problems/target-sum/description/" target="_blank" rel="external">https://leetcode.com/problems/target-sum/description/</a> .<br>这道题本身应该用动态规划做. 不过, 如果用搜索, 这道题仍可以通过, 并不会超时.</p>
<p>zy 同学说, 他用暴力搜索算法, 手写的循环怎么写都不如递归快.<br>于是我也试了一下, 确实如此.</p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;queue&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;set&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unordered_set&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unordered_map&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>; </div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Frame2</span> &#123;</span></div><div class="line">    Frame2() &#123;&#125;</div><div class="line">    Frame2(<span class="keyword">int</span> _level, <span class="keyword">int</span> _sum) &#123;</div><div class="line">        level = _level;</div><div class="line">        sum = _sum;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> level;</div><div class="line">    <span class="keyword">int</span> sum;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">findTargetSumWaysQ</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; nums, <span class="keyword">int</span> target)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">int</span> N = nums.size();</div><div class="line">        <span class="keyword">if</span> (!N) <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        </div><div class="line">        <span class="keyword">int</span> total = <span class="number">0</span>;</div><div class="line">        <span class="comment">// vector&lt;Frame2&gt; stk(nums.size()+1);</span></div><div class="line">        Frame2* stk = (Frame2*)<span class="built_in">malloc</span>((N+<span class="number">1</span>)*<span class="keyword">sizeof</span>(Frame2));</div><div class="line">        stk[<span class="number">0</span>].sum = <span class="number">0</span>;  stk[<span class="number">0</span>].level = <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> stk_ptr = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span> (stk_ptr&gt;=<span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">int</span> pre_sum = stk[stk_ptr].sum;</div><div class="line">            <span class="keyword">int</span> level = stk[stk_ptr].level;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (level == N) &#123;</div><div class="line">                --stk_ptr;</div><div class="line">                <span class="keyword">if</span> (pre_sum == target) &#123;</div><div class="line">                    ++total;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">int</span> num = nums[level];</div><div class="line">            stk[stk_ptr].sum = pre_sum + num;</div><div class="line">            stk[stk_ptr].level = <span class="number">1</span>+level;</div><div class="line"></div><div class="line">            stk[stk_ptr+<span class="number">1</span>].sum = pre_sum - num;</div><div class="line">            stk[stk_ptr+<span class="number">1</span>].level = <span class="number">1</span>+level;</div><div class="line"></div><div class="line">            stk_ptr += <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">free</span>(stk);</div><div class="line">        <span class="keyword">return</span> total;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">findTargetSumWaysR</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; nums, <span class="keyword">int</span> target)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> findTargetSumWaysRecursiveImpl(nums, <span class="number">0</span>, <span class="number">0</span>, target);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">findTargetSumWaysRecursiveImpl</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; nums, <span class="keyword">int</span> level, <span class="keyword">int</span> sum, <span class="keyword">int</span> target)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (level &gt;= nums.size())</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> (<span class="keyword">int</span>)(sum == target);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> findTargetSumWaysRecursiveImpl(nums, level + <span class="number">1</span>, sum + nums[level], target) +</div><div class="line">                    findTargetSumWaysRecursiveImpl(nums, level + <span class="number">1</span>, sum - nums[level], target);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<ul>
<li><code>findTargetSumWaysQ()</code> 和 <code>findTargetSumWaysR()</code> 算法完全相同</li>
<li><code>findTargetSumWaysR()</code> 是zy同学写的递归版</li>
<li><code>findTargetSumWaysQ()</code> 是我的手写循环版本. 不敢说写得最好, 但有以下性质: <ul>
<li>只有一次申请 <code>(N+1)*sizeof(Frame2)</code> 空间的 memory allocation 操作. 这个空间是我手动维护的 call stack.<br>其他都是简单地使用局部变量和赋值操作. 之后编译时将开启优化, 局部变量都应该是放在寄存器里的.</li>
<li><code>if</code> 语句在我看来已经最少了</li>
</ul>
</li>
</ul>
<p>可以去 leetcode 上提交看看, 确实递归版比手写的循环版本更快.</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><h3 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h3><p>使用 gcc (g++) 和 clang (clang++), 在本地 Ubuntu 做实验<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">zsh@zsh-ubuntu:~/workspace/acm_alike$ clang -v</div><div class="line">clang version 3.8.0-2ubuntu4 (tags/RELEASE_380/final)</div><div class="line">Target: x86_64-pc-linux-gnu</div><div class="line">Thread model: posix</div><div class="line">InstalledDir: /usr/bin</div><div class="line">Found candidate GCC installation: /usr/bin/../lib/gcc/x86_64-linux-gnu/5.4.0</div><div class="line">Found candidate GCC installation: /usr/bin/../lib/gcc/x86_64-linux-gnu/6.0.0</div><div class="line">Found candidate GCC installation: /usr/lib/gcc/x86_64-linux-gnu/5.4.0</div><div class="line">Found candidate GCC installation: /usr/lib/gcc/x86_64-linux-gnu/6.0.0</div><div class="line">Selected GCC installation: /usr/bin/../lib/gcc/x86_64-linux-gnu/5.4.0</div><div class="line">Candidate multilib: .;@m64</div><div class="line">Selected multilib: .;@m64</div><div class="line"></div><div class="line"></div><div class="line">zsh@zsh-ubuntu:~/workspace/acm_alike$ gcc -v</div><div class="line">Using built-in specs.</div><div class="line">COLLECT_GCC=gcc</div><div class="line">COLLECT_LTO_WRAPPER=/usr/lib/gcc/x86_64-linux-gnu/5/lto-wrapper</div><div class="line">Target: x86_64-linux-gnu</div><div class="line">Configured with: ../src/configure -v --with-pkgversion=<span class="string">'Ubuntu 5.4.0-6ubuntu1~16.04.9'</span> --with-bugurl=file:///usr/share/doc/gcc-5/README.Bugs --<span class="built_in">enable</span>-languages=c,ada,c++,java,go,d,fortran,objc,obj-c++ --prefix=/usr --program-suffix=-5 --<span class="built_in">enable</span>-shared --<span class="built_in">enable</span>-linker-build-id --libexecdir=/usr/lib --without-included-gettext --<span class="built_in">enable</span>-threads=posix --libdir=/usr/lib --<span class="built_in">enable</span>-nls --with-sysroot=/ --<span class="built_in">enable</span>-clocale=gnu --<span class="built_in">enable</span>-libstdcxx-debug --<span class="built_in">enable</span>-libstdcxx-time=yes --with-default-libstdcxx-abi=new --<span class="built_in">enable</span>-gnu-unique-object --<span class="built_in">disable</span>-vtable-verify --<span class="built_in">enable</span>-libmpx --<span class="built_in">enable</span>-plugin --with-system-zlib --<span class="built_in">disable</span>-browser-plugin --<span class="built_in">enable</span>-java-awt=gtk --<span class="built_in">enable</span>-gtk-cairo --with-java-home=/usr/lib/jvm/java-1.5.0-gcj-5-amd64/jre --<span class="built_in">enable</span>-java-home --with-jvm-root-dir=/usr/lib/jvm/java-1.5.0-gcj-5-amd64 --with-jvm-jar-dir=/usr/lib/jvm-exports/java-1.5.0-gcj-5-amd64 --with-arch-directory=amd64 --with-ecj-jar=/usr/share/java/eclipse-ecj.jar --<span class="built_in">enable</span>-objc-gc --<span class="built_in">enable</span>-multiarch --<span class="built_in">disable</span>-werror --with-arch-32=i686 --with-abi=m64 --with-multilib-list=m32,m64,mx32 --<span class="built_in">enable</span>-multilib --with-tune=generic --<span class="built_in">enable</span>-checking=release --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=x86_64-linux-gnu</div><div class="line">Thread model: posix</div><div class="line">gcc version 5.4.0 20160609 (Ubuntu 5.4.0-6ubuntu1~16.04.9)</div></pre></td></tr></table></figure></p>
<h3 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h3><p>前面已经贴出了算法部分的代码, 这里贴出 <code>main()</code> 函数<br><code>iter_main.cpp</code>:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    Solution s;</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; nums = &#123;<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>, <span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>&#125;;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, s.findTargetSumWaysQ(nums, <span class="number">3</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>recur_main.cpp</code>:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    Solution s;</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; nums = &#123;<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>, <span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>&#125;;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, s.findTargetSumWaysR(nums, <span class="number">3</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>编译命令分别为:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">clang++ -o ./iter2  -O3 cpp_src/iter_main.cpp   -std=c++11 </div><div class="line">clang++ -o ./recur2 -O3 cpp_src/recur_main.cpp  -std=c++11 </div><div class="line"></div><div class="line">g++     -o ./iter3  -O3 cpp_src/iter_main.cpp   -std=c++11 </div><div class="line">g++     -o ./recur3 -O3 cpp_src/recur_main.cpp  -std=c++11</div></pre></td></tr></table></figure></p>
<p>测试速度的命令为:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">time  ./iter2</div><div class="line">time  ./recur2</div><div class="line">time  ./iter3</div><div class="line">time  ./recur3</div></pre></td></tr></table></figure></p>
<h3 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h3><p>注: 每个情形事实上都跑了多次, 并计算了平均的耗时.<br>这里对于每个情形, 仅仅贴出一份能够代表平均耗时的数据, 便于观看.</p>
<p><code>g++</code> 编译的递归版本:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">zsh@zsh-ubuntu:~/workspace/acm_alike$ time ./recur3</div><div class="line">4457400</div><div class="line"></div><div class="line">real	0m0.088s</div><div class="line">user	0m0.084s</div><div class="line">sys	0m0.004s</div></pre></td></tr></table></figure></p>
<p><code>clang++</code> 编译的递归版本:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">zsh@zsh-ubuntu:~/workspace/acm_alike$ time ./recur2</div><div class="line">4457400</div><div class="line"></div><div class="line">real	0m0.230s</div><div class="line">user	0m0.204s</div><div class="line">sys	0m0.004s</div></pre></td></tr></table></figure></p>
<p><code>g++</code> 编译的循环版本:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">zsh@zsh-ubuntu:~/workspace/acm_alike$ time ./iter3</div><div class="line">4457400</div><div class="line"></div><div class="line">real	0m0.109s</div><div class="line">user	0m0.084s</div><div class="line">sys	0m0.008s</div></pre></td></tr></table></figure></p>
<p><code>clang++</code> 编译的循环版本:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">zsh@zsh-ubuntu:~/workspace/acm_alike$ time ./iter2</div><div class="line">4457400</div><div class="line"></div><div class="line">real	0m0.106s</div><div class="line">user	0m0.092s</div><div class="line">sys	0m0.000s</div></pre></td></tr></table></figure></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>性能排序(从好到差): <code>g++递归</code> &gt; <code>clang++循环</code> = <code>g++循环</code> &gt; <code>clang++递归</code>.<br><code>clang++</code> 编译出来的递归版本的性能是符合预期的.<br><code>g++</code> 究竟做了什么优化, 使得递归版本超越了手写的循环版本呢?</p>
<p>注意到, 可执行文件 <code>recur3</code> 大小竟然是 12.9 KB, <code>recur2</code> 仅仅是 8.65 KB;<br>作为比较, <code>iter2</code> 大小是 8.66 KB, <code>iter3</code> 大小是 8.85 KB. </p>
<p>递归版本的源码是远远比循环版本要短的. 然而 <code>g++</code> 编译出来的 <code>recur3</code> 竟然是所有可执行文件中最大的一个.<br>通过命令 <code>g++ -S -o recur3.s  -O3 cpp_src/main.cpp  -std=c++11</code> 观察 <code>g++</code> 编译出的 <code>Solution::findTargetSumWaysRecursiveImpl</code> 函数的汇编代码 (附于本文最后),<br>得出结论: <code>g++</code> <strong>对递归函数做了展开(Recursion flattening), 略微牺牲了二进制文件的大小, 减少了条件跳转, 换取了性能.</strong></p>
<p>这个案例有趣之处在于, <code>g++</code> 对于 <strong>non-tail recursion</strong> 也能进行展开 (flattening), 并能做到超过手工的优化.<br>参考阅读: <a href="http://32leav.es/?p=674" target="_blank" rel="external">http://32leav.es/?p=674</a></p>
<h2 id="g-编译出的-Solution-findTargetSumWaysRecursiveImpl-汇编代码"><a href="#g-编译出的-Solution-findTargetSumWaysRecursiveImpl-汇编代码" class="headerlink" title="g++ 编译出的 Solution::findTargetSumWaysRecursiveImpl 汇编代码"></a><code>g++</code> 编译出的 <code>Solution::findTargetSumWaysRecursiveImpl</code> 汇编代码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div></pre></td><td class="code"><pre><div class="line">_ZN8Solution30findTargetSumWaysRecursiveImplERSt6vectorIiSaIiEEiii:</div><div class="line">.LFB8874:</div><div class="line">	.cfi_startproc</div><div class="line">	pushq	%r15</div><div class="line">	.cfi_def_cfa_offset 16</div><div class="line">	.cfi_offset 15, -16</div><div class="line">	pushq	%r14</div><div class="line">	.cfi_def_cfa_offset 24</div><div class="line">	.cfi_offset 14, -24</div><div class="line">	movslq	%edx, %rdx</div><div class="line">	pushq	%r13</div><div class="line">	.cfi_def_cfa_offset 32</div><div class="line">	.cfi_offset 13, -32</div><div class="line">	pushq	%r12</div><div class="line">	.cfi_def_cfa_offset 40</div><div class="line">	.cfi_offset 12, -40</div><div class="line">	pushq	%rbp</div><div class="line">	.cfi_def_cfa_offset 48</div><div class="line">	.cfi_offset 6, -48</div><div class="line">	pushq	%rbx</div><div class="line">	.cfi_def_cfa_offset 56</div><div class="line">	.cfi_offset 3, -56</div><div class="line">	subq	$232, %rsp</div><div class="line">	.cfi_def_cfa_offset 288</div><div class="line">	movq	(%rsi), %r13</div><div class="line">	movq	8(%rsi), %rax</div><div class="line">	movq	%rdi, 16(%rsp)</div><div class="line">	movq	%rsi, 24(%rsp)</div><div class="line">	movl	%edx, 124(%rsp)</div><div class="line">	movl	%ecx, 100(%rsp)</div><div class="line">	subq	%r13, %rax</div><div class="line">	movl	%r8d, 12(%rsp)</div><div class="line">	movq	%rdx, 136(%rsp)</div><div class="line">	sarq	$2, %rax</div><div class="line">	cmpq	%rdx, %rax</div><div class="line">	movq	%rax, (%rsp)</div><div class="line">	jbe	.L21</div><div class="line">	movl	$0, 216(%rsp)</div><div class="line">	movq	%r13, %r15</div><div class="line">	movq	%rdx, %rax</div><div class="line">.L3:</div><div class="line">	movl	(%r15,%rax,4), %edx</div><div class="line">	addl	$1, 124(%rsp)</div><div class="line">	addq	$1, %rax</div><div class="line">	movq	%rax, 136(%rsp)</div><div class="line">	movl	%edx, 128(%rsp)</div><div class="line">	addl	100(%rsp), %edx</div><div class="line">	cmpq	(%rsp), %rax</div><div class="line">	movl	%edx, 96(%rsp)</div><div class="line">	movl	124(%rsp), %edx</div><div class="line">	jnb	.L4</div><div class="line">	movq	%rax, 152(%rsp)</div><div class="line">	movl	%edx, 104(%rsp)</div><div class="line">	movl	$0, 220(%rsp)</div><div class="line">.L14:</div><div class="line">	movl	(%r15,%rax,4), %edx</div><div class="line">	addl	$1, 104(%rsp)</div><div class="line">	addq	$1, %rax</div><div class="line">	movq	%rax, 152(%rsp)</div><div class="line">	movl	%edx, 160(%rsp)</div><div class="line">	addl	96(%rsp), %edx</div><div class="line">	cmpq	%rax, (%rsp)</div><div class="line">	movl	%edx, 92(%rsp)</div><div class="line">	movl	104(%rsp), %edx</div><div class="line">	jbe	.L5</div><div class="line">	movq	%rax, 168(%rsp)</div><div class="line">	movl	%edx, 112(%rsp)</div><div class="line">	movl	$0, 212(%rsp)</div><div class="line">.L15:</div><div class="line">	movl	(%r15,%rax,4), %edx</div><div class="line">	addl	$1, 112(%rsp)</div><div class="line">	addq	$1, %rax</div><div class="line">	movl	112(%rsp), %esi</div><div class="line">	movq	%rax, 168(%rsp)</div><div class="line">	movl	%edx, 164(%rsp)</div><div class="line">	addl	92(%rsp), %edx</div><div class="line">	cmpq	%rax, (%rsp)</div><div class="line">	movl	%edx, 88(%rsp)</div><div class="line">	jbe	.L6</div><div class="line">	movq	%rax, 192(%rsp)</div><div class="line">	movl	%esi, 116(%rsp)</div><div class="line">	movl	$0, 204(%rsp)</div><div class="line">.L16:</div><div class="line">	movl	(%r15,%rax,4), %edx</div><div class="line">	addl	$1, 116(%rsp)</div><div class="line">	addq	$1, %rax</div><div class="line">	movl	116(%rsp), %esi</div><div class="line">	movq	%rax, 192(%rsp)</div><div class="line">	movl	%edx, 180(%rsp)</div><div class="line">	addl	88(%rsp), %edx</div><div class="line">	cmpq	%rax, (%rsp)</div><div class="line">	movl	%edx, 84(%rsp)</div><div class="line">	jbe	.L7</div><div class="line">	movq	%rax, 184(%rsp)</div><div class="line">	movl	%esi, 120(%rsp)</div><div class="line">	movl	%edx, %edi</div><div class="line">	movl	$0, 176(%rsp)</div><div class="line">.L17:</div><div class="line">	movl	(%r15,%rax,4), %esi</div><div class="line">	addl	$1, 120(%rsp)</div><div class="line">	addq	$1, %rax</div><div class="line">	movl	120(%rsp), %edx</div><div class="line">	movq	%rax, 184(%rsp)</div><div class="line">	addl	%esi, %edi</div><div class="line">	cmpq	%rax, (%rsp)</div><div class="line">	movl	%esi, 200(%rsp)</div><div class="line">	movl	%edi, 80(%rsp)</div><div class="line">	jbe	.L8</div><div class="line">	movq	%rax, 144(%rsp)</div><div class="line">	movl	%edx, 108(%rsp)</div><div class="line">	movl	$0, 132(%rsp)</div><div class="line">.L18:</div><div class="line">	movl	(%r15,%rax,4), %edx</div><div class="line">	addl	$1, 108(%rsp)</div><div class="line">	addq	$1, %rax</div><div class="line">	movl	108(%rsp), %esi</div><div class="line">	movq	%rax, 144(%rsp)</div><div class="line">	addl	%edx, %edi</div><div class="line">	cmpq	%rax, (%rsp)</div><div class="line">	movl	%edx, 208(%rsp)</div><div class="line">	movl	%edi, 60(%rsp)</div><div class="line">	jbe	.L9</div><div class="line">	movl	%esi, 56(%rsp)</div><div class="line">	movq	%rax, 64(%rsp)</div><div class="line">	movl	%edi, %esi</div><div class="line">	movl	$0, 76(%rsp)</div><div class="line">.L20:</div><div class="line">	movl	(%r15,%rax,4), %edx</div><div class="line">	addl	$1, 56(%rsp)</div><div class="line">	addq	$1, %rax</div><div class="line">	movq	%rax, 64(%rsp)</div><div class="line">	addl	%edx, %esi</div><div class="line">	cmpq	%rax, (%rsp)</div><div class="line">	movl	%edx, 72(%rsp)</div><div class="line">	movl	%esi, 44(%rsp)</div><div class="line">	movl	56(%rsp), %edx</div><div class="line">	jbe	.L10</div><div class="line">	movq	%rax, 32(%rsp)</div><div class="line">	movl	%edx, 40(%rsp)</div><div class="line">	movl	%esi, %r14d</div><div class="line">	movl	$0, 52(%rsp)</div><div class="line">	.p2align 4,,10</div><div class="line">	.p2align 3</div><div class="line">.L19:</div><div class="line">	movl	(%r15,%rax,4), %edi</div><div class="line">	addl	$1, 40(%rsp)</div><div class="line">	addq	$1, %rax</div><div class="line">	movl	40(%rsp), %esi</div><div class="line">	movq	%rax, 32(%rsp)</div><div class="line">	addl	%edi, %r14d</div><div class="line">	cmpq	%rax, (%rsp)</div><div class="line">	movl	%edi, 48(%rsp)</div><div class="line">	jbe	.L11</div><div class="line">	movq	%rax, %rbx</div><div class="line">	xorl	%ebp, %ebp</div><div class="line">	movl	%esi, %r12d</div><div class="line">	movl	%r14d, %r13d</div><div class="line">	.p2align 4,,10</div><div class="line">	.p2align 3</div><div class="line">.L13:</div><div class="line">	movl	(%r15,%rbx,4), %r14d</div><div class="line">	movl	12(%rsp), %r8d</div><div class="line">	addl	$1, %r12d</div><div class="line">	movq	24(%rsp), %rsi</div><div class="line">	movq	16(%rsp), %rdi</div><div class="line">	movl	%r12d, %edx</div><div class="line">	addq	$1, %rbx</div><div class="line">	leal	0(%r13,%r14), %ecx</div><div class="line">	subl	%r14d, %r13d</div><div class="line">	call	_ZN8Solution30findTargetSumWaysRecursiveImplERSt6vectorIiSaIiEEiii</div><div class="line">	addl	%eax, %ebp</div><div class="line">	cmpq	%rbx, (%rsp)</div><div class="line">	ja	.L13</div><div class="line">	xorl	%eax, %eax</div><div class="line">	movl	48(%rsp), %edx</div><div class="line">	subl	%edx, 44(%rsp)</div><div class="line">	cmpl	%r13d, 12(%rsp)</div><div class="line">	movl	44(%rsp), %r14d</div><div class="line">	sete	%al</div><div class="line">	addl	%eax, %ebp</div><div class="line">	movq	32(%rsp), %rax</div><div class="line">	addl	%ebp, 52(%rsp)</div><div class="line">	jmp	.L19</div><div class="line">.L11:</div><div class="line">	movl	44(%rsp), %eax</div><div class="line">	subl	48(%rsp), %eax</div><div class="line">	movl	12(%rsp), %esi</div><div class="line">	movl	72(%rsp), %edx</div><div class="line">	subl	%edx, 60(%rsp)</div><div class="line">	cmpl	%esi, %eax</div><div class="line">	sete	%dl</div><div class="line">	cmpl	%r14d, %esi</div><div class="line">	movl	60(%rsp), %esi</div><div class="line">	sete	%al</div><div class="line">	movzbl	%dl, %edx</div><div class="line">	movzbl	%al, %eax</div><div class="line">	addl	52(%rsp), %eax</div><div class="line">	addl	%edx, %eax</div><div class="line">	addl	%eax, 76(%rsp)</div><div class="line">	movq	64(%rsp), %rax</div><div class="line">	jmp	.L20</div><div class="line">.L10:</div><div class="line">	movl	12(%rsp), %edi</div><div class="line">	movl	208(%rsp), %esi</div><div class="line">	subl	%esi, 80(%rsp)</div><div class="line">	movl	44(%rsp), %esi</div><div class="line">	movl	60(%rsp), %edx</div><div class="line">	cmpl	%esi, %edi</div><div class="line">	sete	%al</div><div class="line">	subl	72(%rsp), %edx</div><div class="line">	movzbl	%al, %eax</div><div class="line">	addl	76(%rsp), %eax</div><div class="line">	cmpl	%edi, %edx</div><div class="line">	movl	80(%rsp), %edi</div><div class="line">	sete	%dl</div><div class="line">	movzbl	%dl, %edx</div><div class="line">	addl	%edx, %eax</div><div class="line">	addl	%eax, 132(%rsp)</div><div class="line">	movq	144(%rsp), %rax</div><div class="line">	jmp	.L18</div><div class="line">.L9:</div><div class="line">	movl	200(%rsp), %edx</div><div class="line">	movl	12(%rsp), %esi</div><div class="line">	subl	%edx, 84(%rsp)</div><div class="line">	movl	60(%rsp), %edx</div><div class="line">	movl	84(%rsp), %edi</div><div class="line">	cmpl	%edx, %esi</div><div class="line">	movl	80(%rsp), %edx</div><div class="line">	sete	%al</div><div class="line">	subl	208(%rsp), %edx</div><div class="line">	movzbl	%al, %eax</div><div class="line">	addl	132(%rsp), %eax</div><div class="line">	cmpl	%esi, %edx</div><div class="line">	sete	%dl</div><div class="line">	movzbl	%dl, %edx</div><div class="line">	addl	%edx, %eax</div><div class="line">	addl	%eax, 176(%rsp)</div><div class="line">	movq	184(%rsp), %rax</div><div class="line">	jmp	.L17</div><div class="line">.L8:</div><div class="line">	movl	12(%rsp), %esi</div><div class="line">	movl	%edi, %edx</div><div class="line">	movl	180(%rsp), %edi</div><div class="line">	subl	%edi, 88(%rsp)</div><div class="line">	cmpl	%edx, %esi</div><div class="line">	movl	84(%rsp), %edx</div><div class="line">	sete	%al</div><div class="line">	subl	200(%rsp), %edx</div><div class="line">	movzbl	%al, %eax</div><div class="line">	addl	176(%rsp), %eax</div><div class="line">	cmpl	%esi, %edx</div><div class="line">	sete	%dl</div><div class="line">	movzbl	%dl, %edx</div><div class="line">	addl	%edx, %eax</div><div class="line">	addl	%eax, 204(%rsp)</div><div class="line">	movq	192(%rsp), %rax</div><div class="line">	jmp	.L16</div><div class="line">.L7:</div><div class="line">	movl	12(%rsp), %edi</div><div class="line">	movl	164(%rsp), %esi</div><div class="line">	subl	%esi, 92(%rsp)</div><div class="line">	cmpl	%edx, %edi</div><div class="line">	movl	88(%rsp), %edx</div><div class="line">	sete	%al</div><div class="line">	subl	180(%rsp), %edx</div><div class="line">	movzbl	%al, %eax</div><div class="line">	addl	204(%rsp), %eax</div><div class="line">	cmpl	%edi, %edx</div><div class="line">	sete	%dl</div><div class="line">	movzbl	%dl, %edx</div><div class="line">	addl	%edx, %eax</div><div class="line">	addl	%eax, 212(%rsp)</div><div class="line">	movq	168(%rsp), %rax</div><div class="line">	jmp	.L15</div><div class="line">.L6:</div><div class="line">	movl	92(%rsp), %eax</div><div class="line">	subl	164(%rsp), %eax</div><div class="line">	xorl	%edx, %edx</div><div class="line">	movl	12(%rsp), %esi</div><div class="line">	movl	160(%rsp), %edi</div><div class="line">	subl	%edi, 96(%rsp)</div><div class="line">	cmpl	%esi, %eax</div><div class="line">	sete	%dl</div><div class="line">	xorl	%eax, %eax</div><div class="line">	cmpl	88(%rsp), %esi</div><div class="line">	sete	%al</div><div class="line">	addl	212(%rsp), %eax</div><div class="line">	addl	%edx, %eax</div><div class="line">	addl	%eax, 220(%rsp)</div><div class="line">	movq	152(%rsp), %rax</div><div class="line">	jmp	.L14</div><div class="line">.L5:</div><div class="line">	movl	128(%rsp), %edi</div><div class="line">	movl	92(%rsp), %esi</div><div class="line">	subl	%edi, 100(%rsp)</div><div class="line">	movl	12(%rsp), %edi</div><div class="line">	movl	96(%rsp), %edx</div><div class="line">	cmpl	%esi, %edi</div><div class="line">	sete	%al</div><div class="line">	subl	160(%rsp), %edx</div><div class="line">	movzbl	%al, %eax</div><div class="line">	addl	220(%rsp), %eax</div><div class="line">	cmpl	%edi, %edx</div><div class="line">	sete	%dl</div><div class="line">	movzbl	%dl, %edx</div><div class="line">	addl	%edx, %eax</div><div class="line">	addl	%eax, 216(%rsp)</div><div class="line">	movq	136(%rsp), %rax</div><div class="line">	jmp	.L3</div><div class="line">.L4:</div><div class="line">	movl	128(%rsp), %edx</div><div class="line">	xorl	%eax, %eax</div><div class="line">	subl	%edx, 100(%rsp)</div><div class="line">	movl	96(%rsp), %edi</div><div class="line">	cmpl	%edi, 12(%rsp)</div><div class="line">	movl	100(%rsp), %edx</div><div class="line">	sete	%al</div><div class="line">	addl	216(%rsp), %eax</div><div class="line">.L2:</div><div class="line">	cmpl	%edx, 12(%rsp)</div><div class="line">	sete	%dl</div><div class="line">	addq	$232, %rsp</div><div class="line">	.cfi_remember_state</div><div class="line">	.cfi_def_cfa_offset 56</div><div class="line">	movzbl	%dl, %edx</div><div class="line">	popq	%rbx</div><div class="line">	.cfi_def_cfa_offset 48</div><div class="line">	addl	%edx, %eax</div><div class="line">	popq	%rbp</div><div class="line">	.cfi_def_cfa_offset 40</div><div class="line">	popq	%r12</div><div class="line">	.cfi_def_cfa_offset 32</div><div class="line">	popq	%r13</div><div class="line">	.cfi_def_cfa_offset 24</div><div class="line">	popq	%r14</div><div class="line">	.cfi_def_cfa_offset 16</div><div class="line">	popq	%r15</div><div class="line">	.cfi_def_cfa_offset 8</div><div class="line">	ret</div><div class="line">.L21:</div><div class="line">	.cfi_restore_state</div><div class="line">	xorl	%eax, %eax</div><div class="line">	movl	%ecx, %edx</div><div class="line">	jmp	.L2</div><div class="line">	.cfi_endproc</div></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zsh-89.github.io/2017/12/31/Windows-Debug-3-windows-usermode-debug-基础/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shuhan 同学">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuhan 同学的笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/31/Windows-Debug-3-windows-usermode-debug-基础/" itemprop="url">Windows Debug - 3: windows usermode debug 基础</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-31T23:45:37+08:00">2017-12-31</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>不同 debug 场景, 不同 debug 难度.</p>
<ul>
<li>最简单的是 dev 环境, 可以用 visual studio, 随意增减代码, 打断点, 可以 debug 编译;</li>
<li>最难的 production 环境, 可能只有一个 dump file.</li>
</ul>
<p>本文说的 debug 技术主要是 “拿不到源码” 情况下的 debug 技术.<br>目标是尽可能分析出问题的所在, 由于没有源码, 不试图修复问题.<br>在微软存在专门帮客户分析 production 环境的程序错误的业务.</p>
<p>Windows 操作系统上, 调试 usermode code 的技术:</p>
<ul>
<li>调试 native code (C, C++)</li>
<li>调试 managed code (C#)</li>
<li>Remote debugging</li>
</ul>
<h2 id="词汇术语"><a href="#词汇术语" class="headerlink" title="词汇术语"></a>词汇术语</h2><ul>
<li>attach/detach</li>
<li>break point/conditional break point</li>
<li>debug(checked) build/retail(free) build</li>
<li>local process/remote process</li>
<li>dump file (memory dump)</li>
<li>exception; first-chance exception; second-chance exception<br>Windows 操作系统有 structured exception handling (try-except-finally 语句).<br>有 exception handler 的称为 first-chance, 没有的则为 second-chance.<br>Win32 API: <code>RaiseException()</code> 主动 raise.</li>
<li>step over, step into, step out, run to cursor</li>
<li>symbols, private symbols, public symbols;<br>通常是 .pdb 文件.<br>包含内容: global var, local var, function name, function entry address, source line-number</li>
<li>symbol server</li>
<li>call stack</li>
<li>register</li>
<li>disassembly code</li>
<li>user mode / kernel mode</li>
<li>thread local storage</li>
</ul>
<h2 id="知识补充"><a href="#知识补充" class="headerlink" title="知识补充"></a>知识补充</h2><h3 id="Windows-Virtual-Memory-小知识"><a href="#Windows-Virtual-Memory-小知识" class="headerlink" title="Windows Virtual Memory 小知识"></a>Windows Virtual Memory 小知识</h3><ul>
<li>Virtual Memory Type: MEM_IMAGE, MEM_MAPPED, MEM_PRIVATE</li>
<li>Virtual Page State: Free, Reserved, Committed, Shared</li>
<li>Virtual Memory Protection: PAGE_READONLY, PAGE_GUARD, PAGE_EXECUTE_READ, 等等</li>
</ul>
<h3 id="CPU-寄存器"><a href="#CPU-寄存器" class="headerlink" title="CPU 寄存器"></a>CPU 寄存器</h3><p>intel 寄存器介绍: <a href="https://www.swansontec.com/sregisters.html" target="_blank" rel="external">https://www.swansontec.com/sregisters.html</a>  The Art of Picking Intel Registers.pdf</p>
<h3 id="managed-code-Net"><a href="#managed-code-Net" class="headerlink" title="managed code; .Net"></a>managed code; .Net</h3><p>在 CLR (common language runtime) 上跑的 code, 称为 managed code, 如 C#.<br>C/C++ 常称为 native/unmanged code.</p>
<h3 id="Net-程序的-Domain-的概念-System-Domain-Shared-Domain-App-Domain"><a href="#Net-程序的-Domain-的概念-System-Domain-Shared-Domain-App-Domain" class="headerlink" title=".Net 程序的 Domain 的概念; System Domain, Shared Domain, App Domain"></a>.Net 程序的 Domain 的概念; System Domain, Shared Domain, App Domain</h3><p>App Domain 介绍:</p>
<ul>
<li>轻量级的进程, 在进程中的进程</li>
<li>比进程代价低</li>
<li>被 CLR 管理</li>
<li>起到互相隔离作用</li>
</ul>
<p>System Domain 和 Shared Domain 都是单例的, 每个 managed process 中最多一个;<br>分别起到管理和共享 assembly 的作用.</p>
<h3 id="CLR-简介"><a href="#CLR-简介" class="headerlink" title="CLR 简介"></a>CLR 简介</h3><p>IL: Intermediate Language<br>Manged object;<br>Manged object method table; 调试时候最经常查看一个 object 的 method table.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[C# 或其他 .net manged code 源代码] =====编译==&gt; </div><div class="line">[IL 和 metadata]                   =====runtime 时被执行, 经 JIT 编译==&gt;</div><div class="line">[native code]                      =====执行==&gt;</div></pre></td></tr></table></figure></p>
<p>不被执行的不会被 JIT 编译; 被 JIT 编译过会有标记.</p>
<h2 id="常用-debug-工具"><a href="#常用-debug-工具" class="headerlink" title="常用 debug 工具"></a>常用 debug 工具</h2><ul>
<li>WindDbg    调试</li>
<li>debugDiag  抓 dump file, 自动分析 dump</li>
<li>procDump   抓 dump</li>
<li>perfmon    Windows Performance Monitor</li>
<li>Visual Studio</li>
<li>Profilers, 包括 Visual Studio profiler</li>
</ul>
<h2 id="WinDbg-调试-userspace-unmanaged-code"><a href="#WinDbg-调试-userspace-unmanaged-code" class="headerlink" title="WinDbg 调试 userspace unmanaged code"></a>WinDbg 调试 userspace unmanaged code</h2><p>基本思路</p>
<ul>
<li>确定出问题的进程 (一般比较容易确定)</li>
<li>根据出现的问题的情况抓 dump (有些问题可能需要抓多个 dump)</li>
<li>要确定出问题的线程 </li>
<li>查看 callstack, 查看 memory usage, 查看程序的汇编代码, 查看 exception,<br>等等, 找出问题所在</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">.cls      清屏</div><div class="line">!help &lt;commands&gt;</div><div class="line"></div><div class="line">## unmanaged code 的 callstack 查看</div><div class="line">k   display callstack</div><div class="line">kc  display only function name</div><div class="line">kb  display first 3 params of each funcion</div><div class="line">kv  display addtionally frame-type specific info (FPO frame-pointer-ommision info)</div><div class="line">kd  display raw stack data</div><div class="line">    k 的输出的第一列信息 (&apos;#&apos; 所在列) 就是 frame number</div><div class="line"></div><div class="line">## frame 可以是 call stack 中的一项, 保存一层函数调用相关的所有信息</div><div class="line">.frame &lt;frame_number&gt;    change frame</div><div class="line">u                        反汇编, current frame 的</div><div class="line">    还可以加地址, 例如: u RtlUserThreadStart+0x21</div><div class="line">    默认是不断显示更多的, 更后面的 (offset 更大) 的反汇编的结果</div><div class="line">dv                       display name/values of local variable of frame</div><div class="line">    必须有 private symbol</div><div class="line">.cxr &lt;exception record addr&gt;   reset registers to match context record</div><div class="line">.ecxr                          switch to faulting context record in dump</div><div class="line">~*k                            call stack of all threads</div><div class="line">   </div><div class="line">## unmanged modules (.dll/.exe 就是一个 module)</div><div class="line">x *!             list all modules</div><div class="line">x User32!MB*     list all symbols starting with &quot;MB&quot; in user32.dll</div><div class="line">lm               list loaded modules   </div><div class="line"></div><div class="line">## break points / 调试命令 </div><div class="line">bp &lt;addr&gt;        add break point</div><div class="line">    如: bp PowerBall!wmain+0x3a8</div><div class="line">bl               list break point</div><div class="line">    disable / clear 断点可以通过 bl 输出的 UI 操作</div><div class="line">    bd 0: disable 断点 0</div><div class="line">g                continue running</div><div class="line">r                查看诸多寄存器保存的值</div><div class="line">r @eax=1         将 eax 置为 1</div></pre></td></tr></table></figure>
<h3 id="例子-修改-“抽取-PowerBall-美帝的彩票-”-的小程序"><a href="#例子-修改-“抽取-PowerBall-美帝的彩票-”-的小程序" class="headerlink" title="例子: 修改 “抽取 PowerBall (美帝的彩票)” 的小程序"></a>例子: 修改 “抽取 PowerBall (美帝的彩票)” 的小程序</h3><p>需求:<br>假设我们设定的 input 是 1 2 3 4 5 6;<br>(1 - 5 是我们猜测的普通球编号, 6 是我们猜测的 PowerBall 编号).<br>通过 WinDbg 修改程序 “抽奖” 函数的返回值, 使我们的 input 中奖.</p>
<p>知识点:</p>
<ul>
<li>使用 x 命令查看 symbol, 寻找问题相关的函数</li>
<li>通过 bp 命令设置断点; 熟悉断点, 执行等调试的命令</li>
<li>通过 r 命令修改寄存器的值, 从而修改函数返回值</li>
</ul>
<h4 id="修改过程"><a href="#修改过程" class="headerlink" title="修改过程"></a>修改过程</h4><p>首先, 用 WinDbg “Open Executable” 打开应用程序, 程序会自动被 WinDbg 中断;<br>在我们执行 g 命令前, 程序一直是被中断的状态.</p>
<p>用 x 命令查看 symbol, 找到相关的函数:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">x *!</div><div class="line">x PowerBall!*</div><div class="line">x PowerBall!Draw*</div><div class="line">    查看到 2 个和 Draw 相关的函数</div></pre></td></tr></table></figure></p>
<p>这两个命令可以把断点设在函数入口 (我并不用)<br><code>bp PowerBall!DrawNumber</code><br><code>bp PowerBall!DrawPowerBall</code></p>
<p>通过 <code>u PowerBall!DrawNumber</code> 和继续执行 <code>u</code>, 查看汇编代码;<br>在函数最尾的 ret 语句前用 <code>bp</code> 设置断点 (例如: <code>bp 00aa2ee7</code>);<br>同理, 对 <code>PowerBall!DrawPowerBall</code> 也在返回语句前配置断点.</p>
<p>g 继续执行程序; 在断点处停下; 通过 <code>r @eax=1</code> 把第一次抽奖的结果改为 1 (修改函数的 return value).<br>重复操作, 把抽奖结果分别改为 “2 3 4 5”.<br>在 <code>PowerBall!DrawPowerBall</code> 返回前, 把抽 “PowerBall” 的结果, 用 <code>r @eax=6</code> 改为 6.</p>
<p>其他修改思路: </p>
<ul>
<li>通过 <code>x PowerBall!*</code> 可以看到小程序把我们的输入保存在 <code>PowerBall!g_LotteryTicket = int [6]</code> 中.<br>也可以把这里面的值修改为 “抽奖” 函数的结果.</li>
<li>找到最后 “判定抽奖成功” 的地方, 修改比较结果</li>
</ul>
<h2 id="WinDbg-调试-userspace-managed-code"><a href="#WinDbg-调试-userspace-managed-code" class="headerlink" title="WinDbg 调试 userspace managed code"></a>WinDbg 调试 userspace managed code</h2><p>调试 C# (或其他 .Net 上的托管的语言) managed code, 首先考虑反编译,<br>得到 C# 的源代码, 不需要去学习 IL 指令.</p>
<p><code>sos.dll</code>: general debugging extension for .Net; shipped with .Net;<br>能够让 windbg 更好地调试 .Net 的代码 (否则只能像调试 native code 一样调试 .net code).<br>一定要用上和抓 dump 环境同样版本的 sos.dll</p>
<p>WinDbg 的 Open Executable 和 attach 几乎等价;<br>一般选择先开 exe 再 attch, 这样有机会做 load sos.dll;<br>attach 功能和 DebugDiag 的 “rule 监听” 冲突, 同一时刻只能开一者.</p>
<p>基本思路:</p>
<ul>
<li>确定出问题的进程 (一般比较容易确定)</li>
<li>根据出现的问题的情况抓 dump (有些问题可能需要抓多个 dump)</li>
<li>要确定出问题的线程 </li>
<li>查看 callstack, 查看 memory usage, 查看程序的汇编代码, 查看 exception,<br>等等, 找出问题所在</li>
</ul>
<p>查找关注的 method 的方法: </p>
<ul>
<li>通过 domain 查到 assembly, 通过 assembly 查到 module (一般是 dll/exe 文件),</li>
<li>通过 module 查到到自己关心的类 (method table); </li>
<li>通过 method table 查到自己关心的 method; </li>
<li>定位到 method 后可以去查看反编译的代码, 定位具体问题</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">## 加载 sos.dll</div><div class="line">.loadby sos clr</div><div class="line">.loadby sos mscorwks</div><div class="line">.load &lt;path&gt;\sos</div><div class="line"></div><div class="line">## 通过 domain 查到 assembly, 通过 assembly 查到 module (一般是 dll/exe 文件),</div><div class="line">## 通过 module 查到到自己关心的类 (method table); </div><div class="line">## 通过 method table 查到自己关心的 method; </div><div class="line">## 定位到 method 后可以去查看反编译的代码, 定位具体问题</div><div class="line">!dumpdomain                    list all domain</div><div class="line">!dumpdomain &lt;domain_addr&gt;</div><div class="line">!dumpassembly &lt;assembly_addr&gt;</div><div class="line">!dumpmodule   &lt;module_addr&gt;</div><div class="line"></div><div class="line">## dump method table 和 method description 最经常用的</div><div class="line">!dumpmodule -mt &lt;module_addr&gt;      查看 module 中的所有 method table   </div><div class="line">!dumpmt -md &lt;method_table_addr&gt;    查看 method table 中的所有 method 的 description</div><div class="line">    method 的状态:</div><div class="line">    + PreJIT 预编译</div><div class="line">    + JIT    已被编译; 一般执行到才编译</div><div class="line">    + NONE   没有被编译</div><div class="line">    </div><div class="line">!DumpMT /d &lt;method_table_addr&gt;  可以看到 method table 的 EEClass 信息</div><div class="line">!dumpclass &lt;eeclass_addr&gt;       查看 EEClass 信息; EEClass 信息并不太多用</div><div class="line"></div><div class="line"></div><div class="line">!dumpstack    查看 managed 和 unmanaged 的 stack</div><div class="line">    -EE       只看 managed 的 stack</div><div class="line">!clrstack     查看 managed stack; 比 !dumpstack 不加 EE 要简明得多;</div><div class="line">    -p        show argument</div><div class="line">    -l        show local variables</div><div class="line">    -a        all above</div><div class="line">~*e!clrstack  查看所有 managed thread</div><div class="line">!eestack      查看所有 thread call stack, 以 dumpstack 的方式</div><div class="line">k             查看 unmanaged stack      </div><div class="line"></div><div class="line">!dumpstackobject / !dso</div><div class="line">!do &lt;object_addr&gt;     在 !dso 输出结果里面, 用鼠标点就可以</div><div class="line">!DumpArray            这些命令通常在 UI 上都可以用鼠标点出来</div><div class="line">!dumpheap</div><div class="line">    -stat             group by method</div><div class="line">!eeheap -gc           显示 heap gc 信息</div><div class="line">!address -summary     显示虚拟地址使用情况的统计信息</div><div class="line">    managed 程序的内存往往有 &lt;unknown&gt;; 可以作为识别标志</div><div class="line">    </div><div class="line">!threads              list threads</div><div class="line">!ThreadState &lt;thread_id&gt;   也可以直接 UI 上鼠标点</div><div class="line"></div><div class="line">~.                    current thread info</div><div class="line">~&lt;number&gt;             thread info, 指定线程编号</div><div class="line">~~[&lt;os_thread_id&gt;]    thread info, 指定线程 id</div><div class="line">~*                    all threads in the process</div><div class="line">~#                    thread that caused the exception</div><div class="line"></div><div class="line"># for live debug; thread command</div><div class="line">~e  execute a thread-specific command</div><div class="line">~f  freeze thread</div><div class="line">~u  unfreeze</div><div class="line">~n  suspend</div><div class="line">~m  resume </div><div class="line"></div><div class="line">~~[&lt;os_thread_id&gt;]s   切换当前线程</div><div class="line">    os_thread_id == !thread 的输出中的 OSID 列的信息</div><div class="line">~&lt;managed_thread_id&gt;s 切换当前线程</div><div class="line">    os_thread_id == !thread 的输出中的 ID 列的信息</div><div class="line">    </div><div class="line">!pe / !PrintException    看 managed exception</div><div class="line">    可以用 do! 看 managed exception object 的信息</div><div class="line"></div><div class="line"># 为 manged code 设置 break point; 断点打到 managed method</div><div class="line">!bpmd DebugLab.exe DebugLab.Program.CrashLab</div></pre></td></tr></table></figure>
<h3 id="场景-查看-exception-导致的-crash"><a href="#场景-查看-exception-导致的-crash" class="headerlink" title="场景: 查看 exception 导致的 crash"></a>场景: 查看 exception 导致的 crash</h3><p>操作:</p>
<ul>
<li>抓 dump</li>
<li>WinDbg 打开 dump</li>
<li>load sos.dll</li>
<li>!pe 查看 exception object</li>
<li>!clrstack 查看 call stack</li>
</ul>
<h3 id="场景-hang-问题"><a href="#场景-hang-问题" class="headerlink" title="场景: hang 问题"></a>场景: hang 问题</h3><p>分类 low cpu hang (idle hang), high cpu hang (busy hang);<br>注意 hang 型问题, dump 至少抓 3 个, 间隔时间由实际问题决定.<br>例如, 读取资源本来就要 1min, 那么抓 dump 间隔就要超过 1min.<br>可以用 procdump 或者自己用 powershell 做到 “间隔时间抓 dump”.</p>
<p>DebugDiag Analysis 看可以帮助分析 dump 文件; 例如, 可以统计多少线程在等待.</p>
<p><code>!syncblk, !locks</code> (sos.dll 的命令) 查看正在被等的同步对象/lock, 看到哪个线程持有对象/lock.</p>
<h3 id="场景-memory-leak"><a href="#场景-memory-leak" class="headerlink" title="场景: memory leak"></a>场景: memory leak</h3><p>有可能导致 OutOfMemory (OOM) exception, crash;<br>可以看 Windows Performance Monitor 看内存使用曲线, .net 内存曲线.</p>
<p>mange code 如果也泄漏, 先查 pinvoke 等调用 naitive 代码的地方.</p>
<p>查看是否有 leak 常检验的指标:</p>
<ul>
<li>working set: physical pages owned by a process.</li>
<li>Private Bytes: is the current size, in bytes, of memory that<br>this process has allocated that <strong>CANNOT be shared</strong> with other processes.</li>
</ul>
<p>利用 debugDiag, 先在 ‘process’ tab 选择进程, “monior for leak”, 这样抓的 dump 会包含更多细节.<br>这样的的 dump file 可以在 DebugDiag 的 analysis 中分析出更好的结果,<br>在 WinDbg 也可以看到更多信息.</p>
<p>抓之后, WinDbg 里可以用: <code>!dumpheap</code></p>
<h3 id="场景-high-cpu-hang"><a href="#场景-high-cpu-hang" class="headerlink" title="场景: high cpu hang"></a>场景: high cpu hang</h3><p>runaway thread: stuck 的, 类似陷入死循环的 thread</p>
<p>根据条件抓 dump:<br><code>procdump -ma -u -c 24 -s 5 -n 3 -o BaddApp C:\temp</code><br>    -u Treat CPU usage relative to a single core (used with -c)<br>    -c 24: 4核机器, 超过 24% (有一个核几乎完全被占用) 时抓 dump<br>    -n 3 抓 3 个<br>    -o overwrite existing dump<br>    [Dump_Folder] 是 <code>C:\temp</code></p>
<p>在 WinDbg 中, <code>!runaway</code> 查看线程用时统计. 比较多个 dump 文件中 <code>!runway</code> 的输出,<br>可以找到有问题的 runway 线程.<br>接着切换到对应线程, 查看 callstack 即可.</p>
<p>gc 百分比一般不超过 10%. 有时候 gc 也会导致 high cpu hang。</p>
<h2 id="remote-debug"><a href="#remote-debug" class="headerlink" title="remote debug"></a>remote debug</h2><p>user mode 用得较少了(更经常用 remote desktop, 变成 local debug问题), kernal mode 用得多.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">## 用 WinDbg 在被调试机 (target) 开启服务 (WinDbg 成为 server 机)</div><div class="line">.server tcp:port=9999</div><div class="line">    命令会输出 &lt;debugger&gt; -remote tcp:Port=9999,Server=NPC</div><div class="line">    tcp:Port=9999,Server=NPC 就是之后会用到的 connection string</div><div class="line">.server npipe:pipe=&lt;Pipe Name&gt;</div><div class="line">    命令会输出: &lt;debugger&gt; -remote npipe:Pipe=xyz,Server=NPC</div><div class="line">    npipe:Pipe=xyz,Server=NPC 就是之后会用到的 connection string</div><div class="line">如果是跨公网连接, 前的 connection string 中改为 Server=&lt;ip&gt;, 机器必须是公网可见的</div><div class="line">    </div><div class="line">## 在 host 用 WinDbg 连接到 target:</div><div class="line">WinDbg UI: [File]-&gt;[Connect To Remote Session], 输入前面得到的 connection string</div></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zsh-89.github.io/2017/12/31/Windows-Debug-2-windbg-和-os-配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shuhan 同学">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuhan 同学的笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/31/Windows-Debug-2-windbg-和-os-配置/" itemprop="url">Windows Debug - 2: windbg 和 os 配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-31T23:45:36+08:00">2017-12-31</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="symbol-file-windbg-配置-symbol"><a href="#symbol-file-windbg-配置-symbol" class="headerlink" title="symbol file; windbg 配置 symbol"></a>symbol file; windbg 配置 symbol</h2><h3 id="symbol-简介"><a href="#symbol-简介" class="headerlink" title="symbol 简介"></a>symbol 简介</h3><p>通常就是 <code>.pdb</code> 文件。<br>release 和 debug symbol 要配合对应的 exe 使用, 不可混用.<br>没有 symbol，就看不到函数名，只能看到 <strong>地址</strong>。</p>
<p>public symbol： 包含基本的玩意 (微软发布的就是 public symbol); 可能只有 public 函数等等;<br>private symbol：和我们自己用 VS build 出来的一样. 全. 可以用来干坏事.</p>
<p>symchk.exe (windbg 自带) 可以检测 symbol 文件正确性</p>
<h3 id="windbg-配置-symbol"><a href="#windbg-配置-symbol" class="headerlink" title="windbg 配置 symbol"></a>windbg 配置 symbol</h3><p>可以把 symbol string 设置在两个位置之一, 告诉 windbg ‘symbol 的位置’:</p>
<ul>
<li>设定在 <code>_NT_SYMBOL_PATH</code> 环境变量: <code>srv*https://msdl.microsoft.com/download/symbols</code></li>
<li>通过 UI 设定; 每次设定的值在 windbg 关闭后, 都会被清空.</li>
</ul>
<h3 id="symbol-string-的语法"><a href="#symbol-string-的语法" class="headerlink" title="symbol string 的语法"></a>symbol string 的语法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">srv*c:\mss*http://msdl.microsoft.com/download/symbols;D:\Windbg_training\Setup\Projects\assembly\x64\Release</div><div class="line"></div><div class="line">## 分号分割; (第二个目录是 app specific symbol)</div><div class="line">## srv*c:\mss*http://msdl.microsoft.com/download/symbols; 设定 local cache 行为,</div><div class="line">## cache 目录为 c:\mss</div></pre></td></tr></table></figure>
<h3 id="symbol-server-和-symbol-发布"><a href="#symbol-server-和-symbol-发布" class="headerlink" title="symbol server 和 symbol 发布"></a>symbol server 和 symbol 发布</h3><p>文件系统的共享目录可以作为 symbol server.<br>visual studio 可以配置编译后自动发布 symbol 到 symbol server.</p>
<h2 id="windbg-extension-支持更多的-debug"><a href="#windbg-extension-支持更多的-debug" class="headerlink" title="windbg extension; 支持更多的 debug;"></a>windbg extension; 支持更多的 debug;</h2><p>存在 for .net extension 等等; 有很多开源的 extension;<br>参见: <a href="http://windbg.org" target="_blank" rel="external">http://windbg.org</a></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zsh-89.github.io/2017/12/31/Windows-Debug-1-dump-file-收集方式-配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shuhan 同学">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuhan 同学的笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/31/Windows-Debug-1-dump-file-收集方式-配置/" itemprop="url">Windows Debug - 1: dump file; 收集方式; 配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-31T23:45:35+08:00">2017-12-31</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h2><p>按照程序所在 mode 分类:</p>
<ul>
<li>usermode dump file</li>
<li>kernel mode dump file</li>
</ul>
<h2 id="为什么要收集-dump-file"><a href="#为什么要收集-dump-file" class="headerlink" title="为什么要收集 dump file?"></a>为什么要收集 dump file?</h2><ul>
<li>对于 kernel mode 程序, 一出错基本上就蓝屏, 所以必须通过 dump file 来分析错误原因.</li>
<li>对于 user mode 程序, 有时候不允许工程师远程登录生产环境, 或者不允许工程师拿到源码,<br>也只能借助 dump file 来分析错误.</li>
</ul>
<h2 id="抓取-usermode-dump-file"><a href="#抓取-usermode-dump-file" class="headerlink" title="抓取 usermode dump file"></a>抓取 usermode dump file</h2><p>不推荐用 “任务管理器”.<br>推荐用 debugDiag (可以方便用 GUI 设定生成 dump 的 rule) 或 procDump.</p>
<h3 id="procDump"><a href="#procDump" class="headerlink" title="procDump"></a>procDump</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">procdump -ma -u -c 24 -s 5 -n 3 -o BaddApp.exe C:\temp</div><div class="line">    -ma           full dump</div><div class="line">    -u            Treat CPU usage relative to a single core (used with -c)</div><div class="line">    -c            24: 4核机器, 超过 24% (有一个核几乎完全被占用) 时抓 dump</div><div class="line">    -n            3 抓 3 个</div><div class="line">    -o            overwrite existing dump</div><div class="line">    [Dump_Folder] 上面的命令中, dump 文件输出的目录是 `C:\temp`</div><div class="line"></div><div class="line">procdump -e -ma debuglab        ## -e  monitor crash</div></pre></td></tr></table></figure>
<h3 id="DebugDiag"><a href="#DebugDiag" class="headerlink" title="DebugDiag"></a>DebugDiag</h3><p>DebugDiag 安装完有好多个 exe. 配置抓取 dump 的 rule, 在 DebugDiagCollection 里做.<br>DebugDiag 通过一个后台运行的 service 来抓去 dump. 相比之下, procdump 更加轻量级.</p>
<p>DebugDiag 中配置 “dump 抓取的 rule” 时的注意点:</p>
<ul>
<li>action limits: 代表采集几次 dump, 收集几次 log, 等等</li>
<li>crash 类型的 dump 基本上就是 second chance exception;<br>first change exception 是被程序内部的 exception handler 处理的 exception.</li>
</ul>
<p>debugDiag 的用法例子参见 debug 实例.</p>
<h2 id="抓取-kernelmode-dump-file"><a href="#抓取-kernelmode-dump-file" class="headerlink" title="抓取 kernelmode dump file"></a>抓取 kernelmode dump file</h2><p>原则: 如果怀疑驱动有问题，早早地直接 dump，免得错误扩散。</p>
<h3 id="kernel-dump-file-的级别介绍-配置-dump-file-级别"><a href="#kernel-dump-file-的级别介绍-配置-dump-file-级别" class="headerlink" title="kernel dump file 的级别介绍; 配置 dump file 级别"></a>kernel dump file 的级别介绍; 配置 dump file 级别</h3><p>minimal dump: 几百 K;<br>kernel dump: paged out 的 memory 进不了;<br>full dump: 内存多大就多大;</p>
<p>配置 dump 的级别:<br><code>[修改环境变量的 dialog]-&gt;[Advanced]-&gt;[starup and recovery]</code></p>
<p><code>Kernel memory dump</code> 一般足够了。<br>如果 C 盘不够大：搜索 <code>delegate dump file</code></p>
<p>minidump 的位置：<code>C:\Windows\minidump\*</code><br>内存数据：<code>C:\Windows\MEMORY.DMP</code></p>
<h3 id="利用-OS-“蓝屏后-dump-file-的生成”-的原理-从-pagefile-中拿-dump-file"><a href="#利用-OS-“蓝屏后-dump-file-的生成”-的原理-从-pagefile-中拿-dump-file" class="headerlink" title="利用 OS “蓝屏后 dump file 的生成” 的原理; 从 pagefile 中拿 dump file;"></a>利用 OS “蓝屏后 dump file 的生成” 的原理; 从 pagefile 中拿 dump file;</h3><p>原理:</p>
<ol>
<li>系统把内存信息放到 pagefile 里。</li>
<li>正常启动一次，系统检查 dump 配置，根据配置，把 pagefile 中东西放入 dump file。</li>
</ol>
<p>结论:</p>
<ul>
<li>挂掉、关机、正常重启之后才能有 dump 。</li>
<li>如果不能正常再启动了，那就 <strong>手动把 pagefile 拿出来，它就是 dumpfile</strong> 。改下后缀名即可。</li>
</ul>
<p>[相关问题] 即使 NTFS 文件系统挂了，一样可以生成 dump file?</p>
<blockquote>
<p>系统有 ntfs_dummy 这个进程，专门负责写 dump pagefile。</p>
</blockquote>
<h3 id="强制-蓝屏法-收集-Kernel-mode-dump-file"><a href="#强制-蓝屏法-收集-Kernel-mode-dump-file" class="headerlink" title="(强制) 蓝屏法; 收集 Kernel mode dump file"></a>(强制) 蓝屏法; 收集 Kernel mode dump file</h3><p>强制蓝屏的方式</p>
<ul>
<li>SystemInternal: NotMyFault 强制蓝屏的工具</li>
<li>改注册表，用特殊键盘按键来触发蓝屏。</li>
<li>Call kernel 函数: KeBugCheck(), KeBugCheckEx().</li>
</ul>
<h3 id="windbg-法-live-debug-中-收集-Kernel-mode-dump-file"><a href="#windbg-法-live-debug-中-收集-Kernel-mode-dump-file" class="headerlink" title="windbg 法; live debug 中, 收集 Kernel mode dump file"></a>windbg 法; live debug 中, 收集 Kernel mode dump file</h3><p>用 Windbg <code>dump</code> 命令直接生成dump (系统不停住)。<br>这样生成的 <strong>dump 文件不好</strong>, 因为系统并没有真正停住, 收集到的不是纯粹的 snapshot。</p>
<p>所以, 要发 dump 给 support 时，要说明白是通过这个办法生成的。<br><strong>推荐用蓝屏法来 dump</strong>。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zsh-89.github.io/2017/12/31/LDAP-简介/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shuhan 同学">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuhan 同学的笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/31/LDAP-简介/" itemprop="url">LDAP 简介</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-31T23:42:04+08:00">2017-12-31</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h2><ul>
<li><a href="https://en.wikipedia.org/wiki/Lightweight_Directory_Access_Protocol" target="_blank" rel="external">https://en.wikipedia.org/wiki/Lightweight_Directory_Access_Protocol</a></li>
</ul>
<h2 id="基本"><a href="#基本" class="headerlink" title="基本"></a>基本</h2><p>LDAP 是 Lightweight Directory Access Protocal 的缩写. LDAP 是 “应用层” (Application Level) 的网络协议; </p>
<p>LDAP用于保存 “Directory Information”, 或者说可以对外提供 “Directory services”;</p>
<p>LDAP server 通常使用的端口号是:</p>
<ul>
<li>TCP 389, UDP 389; 传输 LDAP traffic</li>
<li>TCP 636; 传输 LDAP SSL traffic (LDAP SSL 又被成为 LDAPS, LDAP over SSL)</li>
<li>TCP 3268; 传输 LDAP GC (Global Catalog)</li>
<li>TCP 3269; 传输 LDAPS GC</li>
</ul>
<h2 id="常见用途"><a href="#常见用途" class="headerlink" title="常见用途"></a>常见用途</h2><p>可以认为 LDAP 是 web service 级别的一个 dictionary 数据结构 (正如 python 等高级语言中 dictionary);<br>LDAP 也可以说是一个轻量级的, 为特定用途优化的数据库; 方便好用, 自带 web service 功能.</p>
<p>常见用途</p>
<ul>
<li>保存 firmwide web application config </li>
<li>保存 firmwide system config</li>
<li>保存公司的人员信息</li>
</ul>
<h2 id="LDAP-的数据结构-LDAP-entry-LDIF-LDAP-Data-Interchange-Format"><a href="#LDAP-的数据结构-LDAP-entry-LDIF-LDAP-Data-Interchange-Format" class="headerlink" title="LDAP 的数据结构; LDAP entry; LDIF (LDAP Data Interchange Format)"></a>LDAP 的数据结构; LDAP entry; LDIF (LDAP Data Interchange Format)</h2><p>什么是 LDAP 中的 Directory 数据结构:</p>
<ul>
<li>Directory 是 entry 的集合</li>
<li>An <strong>entry</strong> consists of a set of <strong>attributes</strong>.</li>
<li>An attribute has a name (an attribute type or attribute description) and one or more values.<br>The attributes are defined in a schema (see below).</li>
<li>Each entry has a unique identifier: its <strong>Distinguished Name (DN)</strong>.<br>This consists of its <strong>Relative Distinguished Name (RDN)</strong>, constructed from<br>some attribute(s) in the entry, followed by the parent entry’s DN.<br>Think of the <strong>DN as the full file path</strong> and the <strong>RDN as its relative filename</strong><br>in its parent folder (e.g. if <code>/foo/bar/myfile</code> were the DN, then <code>myfile</code> would be the RDN).<br>entry 和文件系统中的 ‘文件’ 类似, 对应于文件 ‘绝对路径’ 概念的是 ‘DN’, 对应于 ‘相对路径’ 概念的是 ‘RDN’.</li>
</ul>
<p>LDAP 本身是 binary protocal, 传输的信息对于机器友好 (相反, HTTP 则是 plain text protocol);<br>不过 LDAP 传输的信息可以用 LDIF (LDAP Data Interchange Format) 用人类易读的方式表示.</p>
<p>以下是一个 LDAP entry 的例子 (用 LDIF 的格式写出):<br><figure class="highlight ldif"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">dn</span>: cn=John Doe,dc=bigsoft,dc=com</div><div class="line"><span class="attribute">cn</span>: John Doe</div><div class="line"><span class="attribute">givenName</span>: John</div><div class="line"><span class="attribute">sn</span>: Doe</div><div class="line"><span class="attribute">telephoneNumber</span>: +1 888 555 6789</div><div class="line"><span class="attribute">telephoneNumber</span>: +1 888 555 1232</div><div class="line"><span class="attribute">mail</span>: john@bigsoft.com</div><div class="line"><span class="attribute">manager</span>: cn=Barbara Doe,dc=bigsoft,dc=com</div><div class="line"><span class="attribute">objectClass</span>: inetOrgPerson</div><div class="line"><span class="attribute">objectClass</span>: organizationalPerson</div><div class="line"><span class="attribute">objectClass</span>: person</div><div class="line"><span class="attribute">objectClass</span>: top</div></pre></td></tr></table></figure></p>
<p>结合例子解读 “directory” 数据结构:</p>
<ul>
<li>每个 entry 一定包含 dn; dn 就是 DN (Distinguished Name); dn 不算是 attribute (虽然很像);</li>
<li>例子中表示 dn 的是第一行 <code>dn: cn=John Doe,dc=bigsoft,dc=com</code>;<br>这个字符串中, <code>cn=John Doe</code> 给出了 RDN (Relative Distinguished Name) (不过 cn 也是 “Common Name” 的缩写),<br><code>dc=bigsoft,dc=com</code> 给出了 parent 的 dn; 字符串中 dc 的含义是 “Domain Component” </li>
<li>可以知道, 这个 entry 已经是 <code>bigsoft.com</code> 这个 domain 下顶层的 entry 了;<br>(这个 entry 的 parent 的 dn 字符串中没有 cn, 所以它的 parent 不是一个 entry 而是 domain).<br>一个非顶层的 entry 的 dn 的例子是: <code>dn: cn=MyAppConfig,cn=Config,dc=bigsoft,dc=com</code></li>
<li>部分 entry 和 entry 之间存在 hierarchy 关系, 即一个 entry 可能是另一个 entry 的 parent.</li>
<li>LDAP entry 的 DN 在 entry 的生命周期中 <strong>可能会改变</strong>; 但是一定是唯一的;<br>部分 LDAP entry 的 optional attribute 中保存了 UUID; UUID 是不变的, 也可以唯一确定地一个 entry.</li>
<li>一个 entry 包含若干个 attribute; </li>
<li>attribute 是 name-values pair, 如例子中这个 attribute <code>telephoneNumber: +1 888 555 6789</code>,<br>它的 attribute name 是 <code>telephoneNumber</code>, attribute values 是 <code>+1 888 555 6789</code>;</li>
</ul>
<p>更多关于 “entry 的 dn” 的例子: </p>
<ul>
<li><code>dn: ou=myGroups,dc=bigsoft,dc=com</code>, <code>ou</code> 的含义是 <strong>Organizational Unit</strong>;</li>
<li><code>dn: cn=John Smith,ou=myGroups,dc=bigsoft,dc=com</code></li>
<li><code>dn: cn=Alen Smith,ou=mySubGroup,ou=myGroups,dc=bigsoft,dc=com</code>; ou 在路径中也可以多次出现</li>
</ul>
<h2 id="client-端可能执行的操作"><a href="#client-端可能执行的操作" class="headerlink" title="client 端可能执行的操作"></a>client 端可能执行的操作</h2><ul>
<li>StartTLS — use the LDAPv3 Transport Layer Security (TLS) extension for a secure connection</li>
<li>Bind — authenticate and specify LDAP protocol version</li>
<li>Search — search for and/or retrieve directory entries</li>
<li>Compare — test if a named entry contains a given attribute value</li>
<li>Add a new entry</li>
<li>Delete an entry</li>
<li>Modify an entry</li>
<li>Modify Distinguished Name (DN) — move or rename an entry</li>
<li>Abandon — abort a previous request</li>
<li>Extended Operation — generic operation used to define other operations</li>
<li>Unbind — close the connection (not the inverse of Bind)</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zsh-89.github.io/2017/12/31/Java-的-synchronized-内部锁/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shuhan 同学">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuhan 同学的笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/31/Java-的-synchronized-内部锁/" itemprop="url">Java 的 synchronized, 内部锁</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-31T23:38:13+08:00">2017-12-31</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="基本"><a href="#基本" class="headerlink" title="基本"></a>基本</h2><p><code>synchronized</code> == 内部锁 (Intrinsic Lock) == 监视器锁 (Monitor Lock / Monitor)</p>
<h2 id="性质-能力"><a href="#性质-能力" class="headerlink" title="性质, 能力"></a>性质, 能力</h2><p>有三个方面重要性质:</p>
<ul>
<li>互斥 (mutex) 能力</li>
<li>可见性 (visibility) 能力</li>
<li>可重入性 (re-entrant)</li>
</ul>
<h3 id="互斥能力-可见性"><a href="#互斥能力-可见性" class="headerlink" title="互斥能力 + 可见性"></a>互斥能力 + 可见性</h3><p>(内部锁关于互斥和可见性的性质见 “内存模型” 笔记)</p>
<h3 id="可重入-可重入性-re-entrant-re-entrancy"><a href="#可重入-可重入性-re-entrant-re-entrancy" class="headerlink" title="可重入, 可重入性 (re-entrant, re-entrancy)"></a>可重入, 可重入性 (re-entrant, re-entrancy)</h3><p>用于描述同步工具的性质. Java 的内置锁 <code>synchronized</code> 和 C# 的 <code>lock() {}</code> 语句都是可重入的.<br>含义是: 某个线程如果试图获得一个已被该线程获得的锁, 这个请求会成功.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span> <span class="keyword">extends</span> <span class="title">FatherClass</span> </span>&#123;</div><div class="line">    <span class="comment">// synchronized 是可重入的 =&gt; 调用 foo() 不会死锁;</span></div><div class="line">    <span class="comment">// 多线程下的递归的代码, 可能会用到 '可重入' 的锁;</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</div><div class="line">        bar();</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">bar</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span> </span>&#123;</div><div class="line">       System.out.println(<span class="string">"I am doing something ..."</span>);</div><div class="line">       <span class="comment">// 如果 synchronized 不是可重入的, 这里就会死锁</span></div><div class="line">       <span class="keyword">super</span>.doSomething();    </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>相比之下, C/C++ 的许多互斥锁 (如 pthread 的 mutex) 通常是没有可重入性;</p>
<p>“获取粒度” 的概念: (per-thread acquire 和 per-invocation acquire)<br>我们常常说, 有 “可重入性” 的锁的获取 <strong>粒度</strong> 是 “线程” (per-thread acquire),<br>而没有 “可重入性” 的锁的获取粒度是 “调用” (per-invocation acquire).</p>
<p>“可重入性” 有时会带来意想不到的奇怪行为.</p>
<h3 id="与-volatile-的比较"><a href="#与-volatile-的比较" class="headerlink" title="与 volatile 的比较"></a>与 <code>volatile</code> 的比较</h3><p><code>synchronized</code> 比 <code>volatile</code> 功能更强; 不仅可以实现可见性,<br>由于有 mutex 能力, 可以让复合操作拥有 “原子性”;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">AddIfNotExist</span><span class="params">(Element e)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (container.find(e) == <span class="keyword">false</span>) &#123;</div><div class="line">        container.add(e);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的例子是经典的实现 “check then execute” 逻辑的代码;<br>在多线程情况下, 即使 container 成员本身自身有线程安全性,<br>如果 “check then execute” 没有用恰当的同步机制保证原子性, 代码的整体逻辑依旧会错.</p>
<p>这里用 <code>synchronized</code> 实现了 “原子性”; 但如果其他操作 container 的代码没有用同样<br>正确地用 <code>synchronized</code> 保护 (参见下文), 那么 “原子性” 可能被破坏 (或这说 ‘不成立’).</p>
<h2 id="正确使用-synchronized-什么是-“用-内部-锁保护某状态变量”"><a href="#正确使用-synchronized-什么是-“用-内部-锁保护某状态变量”" class="headerlink" title="正确使用 synchronized; 什么是 “用 (内部) 锁保护某状态变量”;"></a>正确使用 <code>synchronized</code>; 什么是 “用 (内部) 锁保护某状态变量”;</h2><p>首先要理解 “用 (内部) 锁保护某状态变量” 术语, 其含义:<br>==等于== 对于所有访问某状态变量的代码, <strong>都</strong> 用 <strong>同一个</strong> 锁保护起来<br>==等于== 访问某状态变量之前, <strong>都</strong> 必须先持有 <strong>同一个</strong> 锁.</p>
<p><strong>都</strong> 和 <strong>同一个</strong> 这两点都是重点, 否则起不到保护作用:</p>
<ul>
<li>对于某个状态变量, 只要有一个关于它的操作未被锁保护, 那么那个操作就是不安全的;<br>而且大多数时候, 这会导致其他操作的安全性也被破坏</li>
<li>被不同的锁保护的代码, 相互之间绝无互斥和可见性的保证;<br>这是 Java 内存模型决定的</li>
</ul>
<p>第二, 通常涉及同一个 “不变性条件 (invariant)” 的多个变量, 会用同一个锁来保护.<br>例如, 一个容器的 <code>size</code> 和 <code>isEmpty</code> 成员逻辑上是强耦合的, 通常会用同一个锁来保护.</p>
<p>第三, 持有锁的时间应该尽可能短; 需要长时间才能完成的操作 (无论是CPU密集还是IO密集),<br>不应该在持有锁的时候做.</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zsh-89.github.io/2017/12/28/内存模型-多线程博文索引/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shuhan 同学">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuhan 同学的笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/28/内存模型-多线程博文索引/" itemprop="url">内存模型, 多线程博文索引</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-28T17:51:25+08:00">2017-12-28</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li><p>首先, 是 <a href="https://zsh-89.github.io/2017/12/13/Java-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B-volatile-final-synchronized/">内存模型和内存模型的相关概念</a> .<br>为了能够真正理解各种编程语言提供的同步工具的功能, 必须有对内存模型的深刻的理解.<br>一般的计算机科学与技术的学生都上过 OS 课, 讲解一切多线程同步的种种例子时,<br>当时已经默认程序执行在满足 “顺序一致性” 的内存模型中了; 事实上, 完全不能做这样的假设.<br>理解内存模型, 才能保证自己不会 “不小心写出一辈子调不好的 bug”.</p>
</li>
<li><p><a href="https://zsh-89.github.io/2017/11/14/%E5%A4%9A%E7%BA%BF%E7%A8%8B-%E5%BF%85%E8%A6%81%E6%80%A7-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98-%E9%87%87%E7%BA%B3%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%B9%B6%E5%8F%91%E6%A8%A1%E5%9E%8B%E4%B9%8B%E5%89%8D%E7%9A%84%E8%80%83%E9%87%8F/">多线程: 必要性, 常见问题; 采纳多线程并发模型之前的考量</a> .<br>放一些有点学究意味的基本的概念, 并且说了 “明智的人应该首先考虑是否不应该用多线程, 用其他更容易掌控的并发模型解决问题” 这件事.</p>
</li>
<li><p><a href="https://zsh-89.github.io/2017/12/13/%E5%A4%9A%E7%BA%BF%E7%A8%8B-%E5%8F%AF%E8%A7%81%E6%80%A7-%E5%8F%91%E5%B8%83%E5%92%8C%E9%80%B8%E5%87%BA/">多线程: 可见性, 发布和逸出</a>.</p>
</li>
<li><p><a href="https://zsh-89.github.io/2017/12/13/%E5%A4%9A%E7%BA%BF%E7%A8%8B-%E7%BA%BF%E7%A8%8B%E5%B0%81%E9%97%AD-%E6%A0%88%E5%B0%81%E9%97%AD-ThreadLocal-%E5%8D%95%E7%BA%BF%E7%A8%8B%E5%AD%90%E7%B3%BB%E7%BB%9F/">多线程: 线程封闭, 栈封闭, ThreadLocal, 单线程子系统</a> 一些即用到多线程, 但又避免 “线程间共享 mutable 变量” (万恶之源) 的办法.</p>
</li>
<li><p><a href="https://zsh-89.github.io/2017/12/31/Java-的-synchronized-内部锁/">Java 的 synchronized, 内部锁</a></p>
</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zsh-89.github.io/2017/12/13/多线程-线程封闭-栈封闭-ThreadLocal-单线程子系统/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shuhan 同学">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuhan 同学的笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/13/多线程-线程封闭-栈封闭-ThreadLocal-单线程子系统/" itemprop="url">多线程: 线程封闭, 栈封闭, ThreadLocal, 单线程子系统</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-13T19:52:32+08:00">2017-12-13</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="线程封闭-Thread-Confinement"><a href="#线程封闭-Thread-Confinement" class="headerlink" title="线程封闭 (Thread Confinement)"></a>线程封闭 (Thread Confinement)</h2><p>线程封闭 (Thread Confinement) 是一个让减少 “shared mutable state” 的技术/方法.<br>让尽可能多的 mutable state 成为 “某个线程专有的 mutable state”.</p>
<p>线程封闭常见类型:</p>
<ul>
<li>Ad-hoc 线程封闭: 维护 “线程封闭性” 的职责完全交给程序员, 而不提供系统的, 机制上的, 框架上的辅助;<br>在文档中注明, 否则接手代码的工程师会在无意中使得原本封闭在线程中的对象逸出;</li>
<li>栈封闭 (Stack Confinement): 多用局部变量, 让尽可能多的对象的引用不超出局部作用域</li>
<li>使用 <code>volatile</code> 变量作为共享状态, 把写操作限定在一个线程内部;</li>
<li>Java/C# 的 ThreadLocal 类, 语言的库/机制提供的 per Thread 的对象存储; </li>
<li>单线程子系统 (single-threaded subsystem)</li>
</ul>
<h2 id="单线程子系统-single-threaded-subsystem"><a href="#单线程子系统-single-threaded-subsystem" class="headerlink" title="单线程子系统 (single-threaded subsystem)"></a>单线程子系统 (single-threaded subsystem)</h2><p>顾名思义, 可知概念.<br>最经典的应用在 GUI. 所有的 GUI 框架都有一个单线程子系统:<br>由一个的专门的 ‘事件分发线程’ (Event Dispatch Thread, EDT) 来处理 GUI 事件<br>(也称为 ‘事件队列’ 模型).</p>
<p>“多线程的 GUI 工具包” 被称为 “计算机科学史上的又一个失败的梦想”.<br>许多人尝试过编写多线程的 GUI 框架, 最终, 都因为竟态条件和死锁而回归了事件队列模型.</p>
<p>MVC 设计模式的广泛应用, 更使得 “多线程的 GUI 工具包” 变得不可能实现,<br>因为 MVC 导致了更强的访问顺序的不确定性.</p>
<p>GUI 中的表现层对象 (Presentation Object) 只允许在事件处理线程 (也常被称为 UI 线程) 中访问,<br>完全无需担心同步问题; 在事件处理线程之外, 不允许访问.</p>
<p>“在 GUI 的事件处理线程之外, 需要让 GUI 执行某样操作” 这个问题的解决思路是: </p>
<ul>
<li>通过消息机制通知 GUI 事件处理线程, 事件处理线程根据消息类别主动调用相关的函数</li>
<li>在前一者的基础上, 传递更多的数据, 包括函数的地址和参数等等,<br>将可以描述计算任务的信息打包传递给事件处理线, 让事件处理线程执行<br>C# 的 BeginInvoke, SynchronizationContext, Java Swing 的 Runnable 类型都属于这一类.<br>好处是: 在前者的基础上, 将事件处理线程和具体响应事件的代码逻辑更好地解耦.</li>
</ul>
<p>不宜把慢的事情 (计算密集 or I/O密集) 交给事件处理线程. 毕竟只有一个线程在做事件处理.</p>
<p>“在 GUI 的事件处理线程让计算线程执行某样操作/任务” 这个问题比较直观,<br>如果需要 GUI 和后台计算线程有交互, 可以参考利用 Future/Promise 乃至 Observable 这些异步模型;<br>简而言之, 至少需要提供机制保证:</p>
<ul>
<li>UI 库要有能力打断/通知终止计算线程 (用户手动终止任务);<br>C# java 都有提 “取消/终止” 线程的机制/库,<br>如 java 的 <code>Thread.currentThread().isInterrupted()</code>, C# 的 <code>CancellationToken</code></li>
<li>计算线程要可以向 UI 报告进度;<br>通常, 计算线程定期算出进度信息, 通过 UI 库提供的机制把进度信息传递给 UI 线程,<br>最后由 UI 线程将进度信息展示出来.</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zsh-89.github.io/2017/12/13/多线程-可见性-发布和逸出/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shuhan 同学">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuhan 同学的笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/13/多线程-可见性-发布和逸出/" itemprop="url">多线程: 可见性, 发布和逸出</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-13T19:41:07+08:00">2017-12-13</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="什么是-“可见性”-问题-visibility"><a href="#什么是-“可见性”-问题-visibility" class="headerlink" title="什么是 “可见性” 问题 (visibility)"></a>什么是 “可见性” 问题 (visibility)</h2><p>经典的 ‘不可见’ 问题的例子:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line">    <span class="comment">// shouldStop 和 number 都是被主线程和 RunnerThread 线程之间的 "可变共享状态变量 (mutable shared state)"</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> shouldStop = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> number = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RunnerThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">while</span> (shouldStop == <span class="keyword">false</span>) &#123;</div><div class="line">                Thread.yield();</div><div class="line">            &#125;</div><div class="line">            System.out.println(<span class="string">"I am out, mumber is: "</span> + number);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        (<span class="keyword">new</span> RunnerThread()).start(); </div><div class="line">        <span class="comment">// RunnerThread 可能永远读不到 number 和 shouldStop 的最新值; </span></div><div class="line">        <span class="comment">// 这个现象称为 '不可见 (not visible)', 也就是 number 和 shouldStop '没有被正确发布 (publish)'</span></div><div class="line">        <span class="comment">//</span></div><div class="line">        <span class="comment">// 代码上看, number 先被设为 100, shouldStop 才被设为 true;</span></div><div class="line">        <span class="comment">// 事实上, 由于指令的重排序 (编译器/CPU 都可能对指令重排序),</span></div><div class="line">        <span class="comment">// 可能另一个线程看了 shouldStop = true 时, 看到的 number 依旧为 0</span></div><div class="line">        number = <span class="number">100</span>;</div><div class="line">        shouldStop = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="“发布”-publish-“逸出”-escape"><a href="#“发布”-publish-“逸出”-escape" class="headerlink" title="“发布” (publish) “逸出” (escape)"></a>“发布” (publish) “逸出” (escape)</h2><ul>
<li>发布 (publish): 使对象在其局部作用域之外可用; 通常地, 包括: 对另一个线程可用, 对另一个类可用, 等等.<br>对于对象来说, “可用” 包括且不限于能够拿到对象的引用.</li>
<li>逸出 (escape): 不希望发布的对象事实上被发布, 称为逸出.<br>最常见的逸出情形是, <strong>在对象构造完成前, 对象的 this 引用就被外部获得了</strong>,<br>这时候其他线程通过保存的 this 来执行操作, 会得到莫名其妙的结果, 并破坏对象数据和状态的一致性.</li>
</ul>
<p>“没有逸出” 的充要条件:  do not write a reference to the object being<br>constructed in a place where another thread can see it before the object’s constructor<br>is finished. (来自 java 语言标准, jls9)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 发布的例子</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PublishAsPublicMember</span> </span>&#123;</div><div class="line">    <span class="comment">// 对象的引用作为 public member 被暴露了, 所以对象已经被发布.</span></div><div class="line">    <span class="keyword">public</span> ArrayList&lt;Info&gt; publicInfo;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Init</span><span class="params">()</span> </span>&#123;</div><div class="line">        publicInfo = <span class="keyword">new</span> ArrayList&lt;Info&gt;();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 逸出</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">EscapeInCtor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EscapeInCtor</span><span class="params">(InfoDistributor dist)</span> </span>&#123;</div><div class="line">        SomeExpensiveCtorWork();</div><div class="line">        <span class="comment">// ...</span></div><div class="line">        dist.register(<span class="keyword">this</span>); <span class="comment">// 经典的 "显式 this 引用逸出"</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EscapeInCtor</span><span class="params">(EventSource source)</span> </span>&#123;</div><div class="line">        SomeExpensiveCtorWork();</div><div class="line">        <span class="comment">// ...</span></div><div class="line">        source.registerListener(</div><div class="line">            <span class="keyword">new</span> EventListener() &#123;</div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(Event e)</span> </span>&#123;</div><div class="line">                    doSomeThing(e); <span class="comment">// 经典的 "隐式 this 引用逸出"</span></div><div class="line">                    <span class="comment">// doSomeThing() 这个 method 几乎肯定使用了 this 引用;</span></div><div class="line">                    <span class="comment">// 或者说肯定某种程度地用到了当前对象的成员, 可能改变当前对象状态;</span></div><div class="line">                    <span class="comment">// 这和 "显式 this 引用逸出" 有相同的糟糕结果</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">doSomeThing</span><span class="params">(Event e)</span> </span>&#123;</div><div class="line">        <span class="comment">// </span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>解决构造函数中的 “逸出问题” 的方法有:</p>
<ul>
<li>将部分代码从构造函数移到构造函数之外的 start, initialize 方法中</li>
<li>使用 “工厂方法” (factory method)</li>
</ul>
<h2 id="“可见性”-问题的根源"><a href="#“可见性”-问题的根源" class="headerlink" title="“可见性” 问题的根源"></a>“可见性” 问题的根源</h2><p>‘可见性问题’ 和 ‘发布问题’ 是 “多核架构”, “多 CPU 架构”, “操作的多线程机制”,<br>“编译器优化对指令进行重排序 (Instruction Reorder)”, “存储器的层次架构 (存在多层次的 cache)”,<br>“CPU 指令级并行技术, 特别是同时发射执行多条指令技术, 指令乱序执行 (out-of-order execution)” 的副产品.</p>
<p>“线程” 对于编译器是不可见的; 编译器看不到 “线程”;<br>编译器保证优化前后, 代码的功能性在单线程的情况下等价, 但是可能在多线程情况下就不等价了;<br>例如前面的例子中, <code>shouldStop</code> 和 <code>number</code> 的修改顺序, 在单线程情况下, 完全可以任意改变.</p>
<p>即使编译器没有做调整, 现代的 CPU 同时发射多条指令, 也会导致同样的问题.<br>CPU 不知道哪些变量是特殊的, 哪些不是.</p>
<h2 id="安全发布引用的方法"><a href="#安全发布引用的方法" class="headerlink" title="安全发布引用的方法"></a>安全发布引用的方法</h2><p>一切安全发布能成功的前提都是 “对象被正确构造” (即, 不发生 “逸出”); 否则绝无可能成功.</p>
<ul>
<li>Java 的静态初始化, 如 <code>public static Holder h = new Holder(10)</code>, 由 JVM 保证正确性</li>
<li>让引用成为某个类的 <code>final</code> 成员; 且成员所在的类没有 this 逸出.<br>早期的 java 内存模型中, 在另一个线程访问 final 成员,<br>可能会看到初始化完毕 (构造函数执行完毕) 之前的值;<br>(例如, 对于 int 类型成员, 可能一次看到的值是 0, 另一次看到的是在构造函数中赋予的值).<br>现在, 其他线程看到的一定是 <code>final</code> 成员构造函数执行完毕之后的值.</li>
<li>让引用成为某个类的 <code>volatile</code> 成员; 或使用 <code>AtomicReference</code></li>
<li>让引用成为某个类的成员, 并且用 <code>synchronized</code> 等锁将所有 “操作/读写该成员” 的代码保护起来</li>
<li>利用其他现有的并发库/框架.<br>如, 放入线程安全的容器中, 如 java 的 <code>ConcurrentHashMap</code>, <code>Hashtable</code>, <code>synchronizedMap</code>,<br><code>synchronizedList</code>, <code>Vector</code>, <code>CopyOnWriteArrayList</code>, <code>CopyOnWriteArraySet</code>,<br><code>synchronizedSet</code>, <code>BlockingQueue</code>, <code>ConcurrentLinkedQueue</code>, 再通过容器访问</li>
</ul>
<h2 id="immutable-对象发布"><a href="#immutable-对象发布" class="headerlink" title="immutable 对象发布"></a>immutable 对象发布</h2><p>‘不可变’ (immutable) 存在两种情况; 根据语境, immutable 可能指以下两者的一种或全部:</p>
<ul>
<li>真正的不可变对象, 它满足以下条件<ol>
<li>对象创建后 (构造后) 其状态就不可变</li>
<li>所有的成员都是 <code>final</code> 类型</li>
<li>对象是正确构造的 (没有 this 引用逸出) </li>
</ol>
</li>
<li>逻辑上不可变: 或者称为 ‘事实上不可变 (effectively immutable)’;<br>即没有严格地使用编程语言 feature 加以硬性控制, 但是本身被正确地构造, 且从不被修改的变量</li>
</ul>
<p>真正的 immutable 对象, 一旦它的引用对某个线程可见, 它的所有成员的值都能被 “正确地” 读取到.<br>(‘正确’ 的含义: 所有的成员都被构造完毕了, 不会读取到未构造完毕的状态.<br> 这是由 <code>final</code> 的性质保证的; 参见 “内存模型” 笔记); </p>
<p>“真正的 immutable 对象” 由于由 <code>final</code> 提供的 “Initialization safety” (初始化安全性, 见内存模型笔记),<br>所以可以用任意的方式发布, 一定线程安全(见 “Java Concurrency in Practice, Ch16”).<br>“事实 immutable 对象” 必须用安全的方式发布; 一旦被正确发布, 就是线程安全的.<br>“真正的 immutable 对象” 不害怕被不可靠的第三方修改, 而且它对于维护者来说更清晰, 更可靠.</p>
<h2 id="mutable-对象的发布"><a href="#mutable-对象的发布" class="headerlink" title="mutable 对象的发布"></a>mutable 对象的发布</h2><p>mutable 对象必须用安全的方式发布. 如果跨线程共享的 mutable 对象没有被安全发布, 代码 <strong>一定有错</strong>. </p>
<p>通常来说, 需要用到多线程共享 mutable 对象时, 我们 <strong>几乎不可能只关心变量/对象的发布问题</strong>;<br>因为发布问题 <strong>仅仅解决了 “可见性”</strong> 而已.<br>如果多线程共享 mutable 状态<strong>仅仅解决了可见性问题</strong>, 代码 <strong>一定有错</strong>.</p>
<p>在最经典最简单的情形中, 如上面的例子中, 我们需要一个 flag 来标志另一个线程是否该退出,<br>这时候用 <code>volatile</code> 就可以解决问题. 如果 <code>shouldStop</code> 和 <code>number</code> 都加上 <code>volatile</code>, java 会保证:</p>
<ul>
<li>RunnerThread 能看到两者的最新值</li>
<li>RunnerThread 能看到 <code>shouldStop = true</code> 时, 必能看到 <code>number = 100</code> (与代码中的顺序一致) </li>
</ul>
<p><code>volatile</code> 的完整功能需要通过 java 的内存模型才能完全描述.<br>这个例子中, 我们实际上算是 <strong>用到了简单的 “线程封闭” 思想</strong>: <code>shouldStop</code> 的写操作只在一个线程中出现.<br>所以, 这个例子中, 我们利用 <code>volatile</code> 发布变量, 解决了 <code>shouldStop</code> 的可见性问题;<br>同时, 我们用最简单的 “线程封闭”, 解决了跨线程共享状态的 <strong>写操作的同步问题</strong>.</p>
<p>下面的例子中, <code>volatile</code> 解决且仅仅解决了可见性问题, 代码的逻辑依旧是错的:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 多线程的 serial generator</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerialGen</span> </span>&#123;</div><div class="line">    <span class="comment">// volatile 虽然解决了 gen_ 发布问题, 但是无法保证 "计算不重复的序列号";</span></div><div class="line">    <span class="comment">// gen_ 发布是正确的, 代码的逻辑是错误的.</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// 对于这个问题, 应该使用 AtomicInteger, volatile 是不够的</span></div><div class="line">    <span class="keyword">volatile</span> <span class="keyword">static</span> <span class="keyword">int</span> gen_;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Serial</span><span class="params">()</span> </span>&#123;</div><div class="line">        gen_ = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getSerial</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> gen_++;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们通常是用 “可变共享状态” 配合一套同步算法来解决一个更复杂的问题, 例如 “生产者消费者问题” 等.</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zsh-89.github.io/2017/12/13/Java-内存模型-volatile-final-synchronized/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shuhan 同学">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shuhan 同学的笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/13/Java-内存模型-volatile-final-synchronized/" itemprop="url">Java 内存模型; volatile, final, synchronized</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-13T19:28:15+08:00">2017-12-13</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言-参考文献"><a href="#前言-参考文献" class="headerlink" title="前言, 参考文献"></a>前言, 参考文献</h2><p>这篇东西的目的是: 做一次比较完整的严谨的调查和总结.<br>我自己这方面知识是不少的, 但不系统.</p>
<p>于是, 在开始写这篇之前就不希望参考除了标准文献之外的其他资料.<br>毕竟每个作者在写材料的时候都抱着不同的目标, 有些不严谨的简化确实有其用处;<br>但是犹如传话游戏, 经过多次层叠引用不是完全准确的信息, 每个人都添加一点自己的主观因素,<br>最后重要的规则和概念会变得得面目全非.</p>
<p>唯一拥有定义权的, 一定准确的标准文献只有 Java Language Specification 和 JVM Specification,<br>其中与 Memory Model 相关的部分的内容的前身就是 JSR133.  </p>
<p>可惜标准文档并不自我完备, 并没有真的把事情写明白;<br>看似简要精准的定义, 其实隐含了大量信息, 关键词组/词汇的含义不明,<br>例如, “be consistent with” “predictable” 就包含了大量含义, 绝不是只看字面上的英文词汇就能明白的. </p>
<p>我出发的原意是通过标准文档, 总结:</p>
<ul>
<li>足以指导我写出正确程序, 分析一切异常行为的规则</li>
<li>重要的工具/概念 (如 volatile) 的性质, 行为</li>
</ul>
<p>标准文档的完备性令人不满, 所以实际的主要参考资料改为:</p>
<ul>
<li>JSR133 FAQ; 来自起草 JSR133 的 cs.umd.edu</li>
<li>Java Concurrency in Practice; </li>
</ul>
<p>通过参考这些 “可读” 的资料反过来理解标准中种种定义的含义.</p>
<p>所有参考资料:</p>
<ul>
<li>JSR133: <a href="https://jcp.org/en/jsr/detail?id=133" target="_blank" rel="external">https://jcp.org/en/jsr/detail?id=133</a><br>标准文献: Java Memory Model and Thread Specification Revision</li>
<li>Java Language Specification (Java 语言标准文献) 其中的 Memory Model 章节</li>
<li>JSR 133 FAQ: <a href="http://www.cs.umd.edu/~pugh/java/memoryModel/jsr-133-faq.html" target="_blank" rel="external">http://www.cs.umd.edu/~pugh/java/memoryModel/jsr-133-faq.html</a> </li>
<li><a href="https://docs.oracle.com/javase/tutorial/essential/concurrency/locksync.html" target="_blank" rel="external">https://docs.oracle.com/javase/tutorial/essential/concurrency/locksync.html</a></li>
<li>Java Concurrency in Practice</li>
<li>深入理解 Java 虚拟机, 周志明; </li>
</ul>
<h2 id="硬件平台的-Memory-Model"><a href="#硬件平台的-Memory-Model" class="headerlink" title="硬件平台的 Memory Model"></a>硬件平台的 Memory Model</h2><p>本质上, 任何程序代码都要变为某个硬件平台上的机器指令, 才能被执行.<br>这些机器指令是用硬件平台上的汇编语言描述的.</p>
<p>现代的多核/多CPU架构的硬件上存在 “缓存一致性 (cache coherence)” 问题:<br>多个处理器 (核) 有各自的多级 cache, 跑在它们之上的硬件指令都涉及同一块内存时,<br>有可能出现各自的 cache 中数据不一致的情况.<br>这些问题会使得我们虽然有汇编代码, 却无法从中分析出程序的具体行为.<br>例如, 至少存在以下无法无法绕过的问题:</p>
<ul>
<li>某个核对内存的写指令, 何时对另一个核可见?</li>
<li>某个核对内存的读指令, 究竟是否读到了当前最新值?</li>
</ul>
<p>所以说, 各个 CPU/核 对同一块内存的读的效果和写的效果, 都必须严格定义,<br>否则程序员无法通过汇编代码知道 “同时在多CPU/核上在运行的指令” 的含义/效果/行为.</p>
<p>通过定义 “处理器 (核) 在访问缓存时都需要遵循的读写协议” 或 “内存模型” 来定义执行内存操作的效果.<br>例如, intel 就为自己的产品给出了相关定义: <a href="https://en.wikipedia.org/wiki/Intel_Memory_Model" target="_blank" rel="external">https://en.wikipedia.org/wiki/Intel_Memory_Model</a></p>
<h2 id="java-内存模型-java-memory-model-JMM-MM-JMM"><a href="#java-内存模型-java-memory-model-JMM-MM-JMM" class="headerlink" title="java 内存模型 (java memory model(JMM), MM, JMM)"></a>java 内存模型 (java memory model(JMM), MM, JMM)</h2><p>硬件平台的汇编语言需要 memory model, 高级语言同样需要.<br>否则, 一旦涉及 “同时并发运行的多线程” 代码, 程序员就无法通过分析高级语言代码本身知道其行为.<br>如果语言标准不规定好内存模型, 那么它的多线程程序就完全没有可移植性;<br>其多线程代码的行为, 必须靠分析具体的编译器的实现和程序所在的硬件平台的内存模型才能得知.</p>
<p>java 的内存模型是 java 程序跨平台性的保证.<br>java 是最早提供内存模型的语言; 之后, C++ 等其他语言也开始注意到内存模型的重要性, 开始完善.</p>
<p>内存模型必须足够严格, 使得读写操作的效果不产生歧义;<br>内存模型必须足够宽松, 使得虚拟机可以自由地利用软件硬件的加速技术<br>(如 CPU 的执行乱序执行, 编译器的指令重排序, 等等).</p>
<p>JDK 1.5 之后, java 的内存模型趋于完善.</p>
<h2 id="重要概念"><a href="#重要概念" class="headerlink" title="重要概念"></a>重要概念</h2><h3 id="happens-before-规则-Happens-Before-Order-HB-规则-HB"><a href="#happens-before-规则-Happens-Before-Order-HB-规则-HB" class="headerlink" title="happens-before 规则 (Happens-Before Order; HB 规则; HB)"></a>happens-before 规则 (Happens-Before Order; HB 规则; HB)</h3><p>标准中的定义: Two actions can be ordered by a happens-before relationship.<br>If one action happens-before another, then the first is visible to and ordered before the second.<br>记法: If we have two actions x and y, we write hb(x, y) to indicate that x happens-before y.</p>
<p>为什么需要 HB 规则?<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> important_data = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">// 线程2</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RunnerThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">while</span> (flag == <span class="keyword">false</span>) &#123;</div><div class="line">                Thread.yield();</div><div class="line">            &#125;</div><div class="line">            System.out.println(<span class="string">"important_data is: "</span> + important_data);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 线程1</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        (<span class="keyword">new</span> RunnerThread()).start();</div><div class="line">        important_data = <span class="number">15</span>;</div><div class="line">        flag = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>只看代码, 我们可能期望:</p>
<ol>
<li>在时序上, “important_data 的赋值” (记为 A) 先于 “flag 的赋值” (记为 B) 先于<br>“线程2输出 important_data” (记为 C)</li>
<li>线程2在输出 important_data 时, 可以看到其最新的值, 即 15</li>
</ol>
<p>不过, 由于编译器优化和CPU硬件指令优化, A B 的时序是不确定的;<br>编译器的 “指令重拍” 可能令 B 在时序上先于 A 发生.<br>所以, 第一点期望未必成立.</p>
<p>假设事件发生的时序确实是 A -&gt; B -&gt; C, 线程2输出的也未必是 15, 因为 A 的结果未必对 C 可见<br>(C 可能跑在另一个 CPU 核上, 其 cache 中 important_data 的值未必有及时得到更新).<br>所以, 第二点期望未必成立.</p>
<p>显然, 在多线程编程中, 我们有些时候需要足够强的工具,<br>让我们能让 “代码上看起来先发生的动作确实先发生”, 而且让 “先发生的动作的结果确实地对后面的动作可见”;<br>这就是 happens-before 规则的意义.</p>
<p>这里的例子中, 只要保证有 <code>hb(A, B)</code> 和 <code>hb(B, C)</code>, 程序的行为就能满足我们的期望.</p>
<p>并不是任何时候都用同步工具保证 happens-before 对于每一条语句都成立,<br>这是不经济的; 对于非线程间共享的值, 或者 immutable 的值, 完全没有必要.<br>过于严格的规则相当于禁止了编译器和硬件的优化, 降低性能.</p>
<p>“happens-before 规则” 实际上是一个描述 “约束” 的工具.<br>Java 标准用它来精准地定义 Java MM 的种种行为,<br>用它来精准地定义各种同步工具如 <code>volatile</code>, <code>synchronized</code> 的性质.</p>
<h3 id="线程内-as-if-serial-语义-within-thread-as-if-serial-semantic"><a href="#线程内-as-if-serial-语义-within-thread-as-if-serial-semantic" class="headerlink" title="线程内 as-if-serial 语义 (within-thread as-if-serial semantic)"></a>线程内 as-if-serial 语义 (within-thread as-if-serial semantic)</h3><p>同义词:</p>
<ul>
<li>within-thread as-if-serial semantic (as-if-serial 语义)</li>
<li>intra-thread semantics</li>
</ul>
<p>Java 语言标准保证: 在任何时候, 在一同线程内部, 一定满足 as-if-serial 语义, 即:<br>Java 编译器, JVM, 硬件可以使用一切优化手段, 包括且不限于调整语句执行顺序, 只要满足:<br>在线程内, 程序的执行效果等价于顺序执行每一个语句的结果.<br>as-if-serial 可以认为是 Java MM 提供的 “低保”.</p>
<blockquote>
<p>The compiler, runtime, and hardware are supposed to conspire to create the illusion of as-if-serial semantics, which means<br>that in a single-threaded program, the program should not be able to observe the effects of reorderings.</p>
<p>— By JSR-133 FAQ</p>
</blockquote>
<p>“线程内的 as-if-serial 语义” 并不是很强的约束; 例如前面部分的例子,<br>仅看线程1, “编译器调换 A B 执行顺序” 完全符合 as-if-serial 语义;<br>但一旦考虑线程2的逻辑, “调换 A B 执行顺序” 就完全破坏了我们对代码行为的期望.</p>
<h3 id="数据竞争-data-race-sequential-consistency-顺序一致性-correctly-synchronized-正确同步"><a href="#数据竞争-data-race-sequential-consistency-顺序一致性-correctly-synchronized-正确同步" class="headerlink" title="数据竞争 data race; sequential consistency 顺序一致性; correctly synchronized 正确同步"></a>数据竞争 data race; sequential consistency 顺序一致性; correctly synchronized 正确同步</h3><p>数据竞争 data race 和 race condition 不同, 虽然有联系.</p>
<p>Java 标准文档中对 data race 的定义:<br>When a program contains two <strong>conflicting accesses</strong><br>(if at least one of the accesses is a write) that are not ordered by<br>a happens-before relationship, it is said to contain a data race. </p>
<p>简单地说, 同时满足这三个条件就存在数据竞争:</p>
<ul>
<li>一个进程中, 2个或2个以上的线程同时访问同一块内存空间, </li>
<li>至少一个线程执行写操作 (即存在 <strong>冲突操作</strong>),</li>
<li>这些冲突操作 (没有通过编程语言的机制建立) HB 约束关系.<br>(毫无信息量的白话版: 这些冲突的读/写操作没有正确地通过同步机制建立顺序关系;<br> 为什么毫无信息量: “正确同步” 就是用 data race 和 ‘顺序一致性’ 定义的.<br> (白话版的英文: are not <strong>ordered</strong> by synchronization; not correctly synchronized))</li>
</ul>
<p>freedom from data race 是相当强的约束, 由于冲突操作间都有 HB 关系, 意味着:<br>对同一块内存, 每一个读操作都一定能读到前一个写操作的结果 (写可以来自包括其他线程的任意线程).</p>
<p>sequential consistency 等价于 freedom from data race (data race free), 是同义词汇.</p>
<p><strong>correctly synchronized</strong>: All execution of the program will appear to be sequential consistent<br>(freedom from data race).</p>
<h3 id="顺序一致性-sequential-consistency-freedom-from-data-race-保证程序-predictable-的性质"><a href="#顺序一致性-sequential-consistency-freedom-from-data-race-保证程序-predictable-的性质" class="headerlink" title="顺序一致性 sequential consistency / freedom from data race; 保证程序 predictable 的性质"></a>顺序一致性 sequential consistency / freedom from data race; 保证程序 predictable 的性质</h3><p>(几乎全引用自标准本身, 晦涩; 参考 <code>volatile</code> 的例子才能解读)</p>
<p>标准中的定义 intra-thread semantics (线程内语义): </p>
<ul>
<li>is the semantics for single-threaded programs</li>
<li>allow the <strong>complete prediction of the behavior</strong> of a thread<br>based on the values seen by read actions within the thread. </li>
</ul>
<p>标准中的定义 program order (of inter-thread actions):<br>Total order (of <strong>inter-thread</strong> / <strong>intra-thread</strong> actions)<br>that <strong>reflects</strong> the order in which these would be performed<br>according to the <strong>intra-thread</strong> semantics.</p>
<p>标准中的定义 sequential consistency: all <strong>inter-thread actions</strong> occur in a total order<br>(the execution order) that <strong>is consistent with program order</strong>, and<br>对同一块内存, 每一个读操作都一定能读到前一个 (时间上最近的前一个) 写操作的结果<br>(写可以来自包括其他线程的任意线程).</p>
<p>标准对 sequential consistency 评价 “很强”:<br>Sequential consistency is a very strong guarantee that is made about visibility and<br>ordering in an execution of a program. Within a sequentially consistent execution,<br>there is a total order over all individual actions (such as reads and writes) which is<br>consistent with the order of the program, and each individual action is atomic and<br>is immediately visible to every thread.</p>
<p>sequential consistency 等价于 freedom from data race (data race free), 是同义词汇.</p>
<p>关于 all <strong>inter-thread actions</strong> occur in a total order, 即 “所有线程看到的 action 的顺序是同一个”;<br>辅助理解的例子:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Thread 1</span></div><div class="line">x = <span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="comment">// Thread 2</span></div><div class="line">y = <span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="comment">// Thread 3</span></div><div class="line"><span class="keyword">if</span> (x == <span class="number">1</span> &amp;&amp; y == <span class="number">0</span>) &#123; print(<span class="string">"x first"</span>); &#125; </div><div class="line"></div><div class="line"><span class="comment">// Thread 4</span></div><div class="line"><span class="keyword">if</span> (y == <span class="number">1</span> &amp;&amp; x == <span class="number">0</span>) &#123; print(<span class="string">"y first"</span>); &#125;</div></pre></td></tr></table></figure></p>
<p>顺序一致性保证: 要么只输出 “x first”, 要么只输出 “x first”, 要么两者都不输出, 永远不出现两者都输出的情况;</p>
<p>sequential consistency 是相当强的约束; 编写多线程程序的程序员会喜欢它,<br>但是并不能直接拿它作为一个程序语言的 MM, 因为它限制过多, 阻碍了编译器优化和CPU并发技术. </p>
<p>标准指出: sequential consistency 虽然强, 但它 still allows errors arising<br>from groups of operations that need to be perceived atomically and are not.</p>
<h2 id="Java-内存模型的策略-as-if-serial-的进一步解释"><a href="#Java-内存模型的策略-as-if-serial-的进一步解释" class="headerlink" title="Java 内存模型的策略; as-if-serial 的进一步解释"></a>Java 内存模型的策略; as-if-serial 的进一步解释</h2><p>Java 语言是允许出现 data race 的; Java 语言只保证 “线程内 as-if-serial 语义”.<br>如果 Java 语言标准要求 “Java 内存模型” 任何时候都满足 sequential consistency,<br>那么非常多的优化技术都不能用了, 这是不经济的.<br>Java 的做法是, 提供足够的同步工具, 让程序员可以为特定重要的代码自己实现 sequential consistency.</p>
<p>一般未加同步的代码, 我们只能假设:<br>在线程内部, 程序运行的效果等价于一步步顺序地执行每一个语句的结果 (as-if-serial) </p>
<p>“一步步顺序地执行 (serial)” 包括性质:</p>
<ul>
<li>代码中前面的语句在后面的语句之前执行, 完全按照程序代码中的顺序执行 </li>
<li>后面的语句总是能看到前面的语句执行的结果 (线程内部的 visibility)).</li>
</ul>
<p>“as-if-serial” 表示程序运行起来, 从线程内部看, 就好像满足以上性质一样.</p>
<p>回头看 HB 部分的例子,<br>我们总可以认为, 在线程1中, 语句是顺序执行的;<br><code>flag = true</code> 被执行时, 前一个语句已经被执行了, 而且能看到前一个语句执行的结果.<br>但是, 由于 <code>flag</code> 没有使用任何同步机制, 所以线程2并不能看到线程1所看到的,<br>“能否看到, 能看到什么, 以什么顺序看到” 几乎都是未定义的<br>(给编译器和硬件留下了充分的自由度, 进行指令优化).</p>
<h2 id="Java-内存模型保证成立的-“HB-关系”"><a href="#Java-内存模型保证成立的-“HB-关系”" class="headerlink" title="Java 内存模型保证成立的 “HB 关系”"></a>Java 内存模型保证成立的 “HB 关系”</h2><blockquote>
<ol>
<li>Each action <strong>in a thread</strong> happens before every action in that thread that comes later in the program’s order.</li>
<li>An unlock on a monitor happens before every subsequent lock on <strong>that same</strong> monitor.</li>
<li>A write to a volatile field happens before every subsequent read of <strong>that same</strong> volatile.</li>
<li>A call to start() on a thread happens before any actions in the started thread.</li>
<li>All actions in a thread happen before any other thread successfully returns from a join() on that thread.</li>
</ol>
<p>— By JSR-133 FAQ</p>
</blockquote>
<p>在标准中描述了更多其他 Java MM 保证一定成了的 “HB 关系”, 但是 FAQ 写的这 5 条和后面列出的 8 条是重点.</p>
<p>注意 “comes later”, “subsequent” 这些本身就在描述先后关系的词汇.<br>例如 “An unlock on a monitor happens before every subsequent lock on that same monitor”;<br>如果没有 HB 约束, 可能出现以下行为:</p>
<ul>
<li>源代码角度看, 更前面的 unlock 的执行时间可能在更后面的 lock 执行时间之前<br>(重排序, 乱序执行等可以造成这个效果)  </li>
<li>即使某个 unlock 的执行时间先于后面的 lock, 这个 unlock 执行结果未必对后面那个 lock 可见</li>
</ul>
<p>逐点解读:</p>
<ul>
<li>关于 1: 事实上 1 就是保证了 as-if-serial 效果. 这句话在标准中对应的一句话是:<br>“If x and y are actions of the same thread and x comes before y in program order,<br>then hb(x, y).”<br>注意: 措辞上 “in a thread”/“of the same thread” 表示描述的是线程内部的效果;<br>还有, program order 未必是唯一的, program order 只要 “<strong>reflects</strong> the order in which these actions<br>would be performed according to the <strong>intra-thread</strong> semantics.” 就可以了;<br>program order 是灵活的, 允许重排序的.<br>这一条在 “Java Concurrency in Practice” 中被成为 “Program order rule”.</li>
<li>关于 2-3: 描述了 <code>lock/unlock</code> 和 <code>volatile</code> 的一部分性质; 它们完整的性质将在下文描述</li>
<li>关于 4-5: 符合程序员对于线程行为的基本期望 </li>
</ul>
<blockquote>
<p>The rules for happens‐before are:</p>
<ol>
<li>Program order rule. Each action in a thread happens‐before every action in that thread that comes &gt;    later in the program order.</li>
<li>Monitor lock rule. An unlock on a monitor lock happens‐before every subsequent lock on that same &gt;    monitor lock.<br>(Locks and unlocks on explicit Lock objects have the same memory semantics as intrinsic locks.)</li>
<li>Volatile variable rule. A write to a volatile field happens‐before every subsequent read of that &gt;    same field.<br>(Reads and writes of atomic variables have the same memory semantics as volatile variables.)</li>
<li>Thread start rule. A call to Thread.start on a thread happens‐before every action in the started &gt;    thread.</li>
<li>Thread termination rule. Any action in a thread happens‐before any other thread detects that<br>thread has terminated, either by successfully return from <code>Thread.join</code> or by <code>Thread.isAlive</code> returning false.</li>
<li>Interruption rule. A thread calling interrupt on another thread happens‐before the interrupted &gt; thread detects the<br>interrupt (either by having InterruptedException thrown, or invoking isInterrupted or interrupted).</li>
<li>Finalizer rule. The end of a constructor for an object happens‐before the start of the finalizer for that object.</li>
<li>Transitivity. If A happens‐before B, and B happens‐before C, then A happens‐before C.<br>(事实上这一条是 total order 的性质决定的)</li>
</ol>
<p>— By <java concurrency="" in="" practice=""></java></p>
</blockquote>
<h2 id="Java-内存模型提供的的基本同步工具"><a href="#Java-内存模型提供的的基本同步工具" class="headerlink" title="Java 内存模型提供的的基本同步工具"></a>Java 内存模型提供的的基本同步工具</h2><h3 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a><code>volatile</code></h3><p>Java 的 <code>volatile</code> 实现了对于一个变量的 ‘顺序一致性’.</p>
<p>volatile 的性质:</p>
<ul>
<li>保证被 <code>volatile</code> 修饰的变量的跨线程可见性 (visibility):<br>所有线程都一定能看到 volatile 共享变量上一次 (最近一次) 被写入的值<br>(标准通过 synchronization order (保证存在跨线程的与 program order 一致的 total order) 定义该性质;<br> A write to a volatile var v synchronizes-with all subsequent reads of v by any thread<br> (where ‘subsequent’ is defined according to the synchronization order))</li>
<li>Anything that was visible to thread A when it writes to volatile field f<br>becomes visible to thread B when it reads f.<br>注意, 必须是同一个 volatile 变量 (前文中都是 ‘f’), 不同的 volatile 变量是没有这样的保证的.</li>
</ul>
<p>关于第二点, 继续参考 HB 部分的例子. 我们可以认为, 在线程1中, 语句执行效果等价于顺序执行的效果;<br><code>flag = true</code> 被执行时, 前一个语句 <code>important_data = 15</code> 已经被执行了;<br>而且 <code>flag = true</code> 能看到前一个语句执行的结果.</p>
<p>现在, 由于 <code>flag</code> 使用了 <code>volatile</code> 同步机制, 所以线程2也像线程1一样,<br>看到 <code>flag = true</code> 的结果时, 一定能看到之前的语句 <code>important_data = 15</code> 的结果.<br>(准确地说, 实际上 <code>volatile</code> 保证的是 “Java 保证线程2运行的效果等价于<br> 满足 ‘线程2能先看到 <code>important_data = 15</code> 的结果, 再看到 <code>flag = true</code> 的结果’ 的情况下<br> 程序的运行结果”;<br> <strong>只要求结果等价</strong>, 不要求严格地照搬规则执行; 不把话说死, 从而就没有把优化的空间封死.<br> 如果在 <code>volatile</code> 前面的语句运行的结果 “完全无关紧要(不影响结果, totally irrelevant)”,<br> 那么实际的实现可以根本不真正去做<br> ‘让线程2能先看到 <code>important_data = 15</code> 的结果,  再看到 <code>flag = true</code>‘ 这件事)</p>
<p>用 HB 的传递性来帮助理解 “any thing that is visible when XXX action happens”;<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 假设所有变量都是 volatile </span></div><div class="line"></div><div class="line"><span class="comment">// Thread 1</span></div><div class="line">g=<span class="number">1</span>; x=<span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="comment">// Thread 2</span></div><div class="line"><span class="keyword">if</span> (x == <span class="number">1</span>) y = <span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="comment">// Thread 3</span></div><div class="line"><span class="keyword">if</span> (y == <span class="number">1</span>) <span class="keyword">assert</span>(g == <span class="number">1</span>);  </div><div class="line"><span class="comment">// g=1操作在 Thread 1 发生, 它的可见性通过 happens before 传递了2个线程</span></div></pre></td></tr></table></figure></p>
<p>(参见前小节中 Java 保证成立的 HB 约束中的 “Volatile variable rule”)</p>
<h3 id="final"><a href="#final" class="headerlink" title="final"></a><code>final</code></h3><p><code>final</code> 解决的问题: 早期的 JMM 中 (1.5 版本之前), final 的语义约束并没有现在这么强,<br>有时从其他线程观察, <code>final</code> 成员的值会发生变化, 与程序员的期望不一致.<br>就是说, “发布 (publish, 即 make visible) 对象的引用” 的指令被重排序, 提前被执行,<br>而构造函数还没有被执行完, 其他线程看到了 final 成员的 default initial value 或其他中间状态.</p>
<p>现在的 JMM 中, 只要对象的构造 “不发生逸出”, <code>final</code> 可以保证:</p>
<ul>
<li>the values assigned to the final fields in the constructor will be visible to<br>all other threads without synchronization.<br>即, 只要我们能在某个线程看到对象的引用, 我们就一定能 “正确地” 看到对象的 final 域的值,<br>不需要其他同步措施.</li>
<li>the visible values for any other object or array referenced by those final fields<br>will be at least as up-to-date as the final fields<br>即, final 域的 “正确性” 是递归地得到保证的; (例如, 假如你的类中有一个 final 数组成员,<br>你除了关心数组的引用本身的 “正确性”, 你也关心数组中的每一个元素的 “正确性”;<br>Java MM 可以保证后一点也正确.)</li>
</ul>
<p>补充说明: </p>
<ul>
<li>构造函数 “没有逸出” 的充要条件:  do not write a reference to the object being<br>constructed in a place where another thread can see it before the object’s constructor<br>is finished. (来自 java 语言标准, jls9)<br>(更多可参考 “可见性, 发布和逸出, 发布对象引用.md”)</li>
<li>“正确地/正确性” = “up to date as of the end of the object’s constructor”, not “the latest value available”. </li>
<li>final 的性质被成为 “Initialization safety” (初始化安全性)</li>
</ul>
<p><code>final</code> 与 <code>volatile</code> 比较的例子:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SafeStates</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Map&lt;String, String&gt; states;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SafeStates</span><span class="params">()</span> </span>&#123;</div><div class="line">        states = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</div><div class="line">        states.put(<span class="string">"alaska"</span>, <span class="string">"AK"</span>);</div><div class="line">        states.put(<span class="string">"alabama"</span>, <span class="string">"AL"</span>);</div><div class="line">        states.put(<span class="string">"wyoming"</span>, <span class="string">"WY"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAbbreviation</span><span class="params">(String s)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> states.get(s);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这段代码中, 将 <code>volatile</code> 改为 <code>final</code> 将会破坏 “初始化安全性”.<br><code>volatile</code> 的性质描述中是完全不涉及 “构造函数” 的;<br>如此, 某个现成看到 SafeStates 类型对象的引用时, states 成员 <strong>未必</strong> 被初始化完毕;<br>读取 states 可能读取到 null, 或者读到部分初始化的状态. </p>
<h3 id="内部锁-intrinsic-monitor-lock-synchronized"><a href="#内部锁-intrinsic-monitor-lock-synchronized" class="headerlink" title="内部锁, intrinsic/monitor lock, synchronized"></a>内部锁, intrinsic/monitor lock, <code>synchronized</code></h3><p>intrinsic lock === monitor lock, 又被简称为 monitor.<br><code>synchronized</code> 用到的机制就是 monitor.</p>
<p>synchronized block: 被 <code>synchronized</code> 保护的代码区域.</p>
<p><code>synchronized</code> 的性质 &amp; 作用:</p>
<ul>
<li>Every object has an intrinsic lock associated with it.<br>从代码角度看, 任何 Java Object (假设名字是 <code>x</code>) 都可以使用 <code>synchronized(x) {}</code> 语句.</li>
<li>Synchronization ensures that memory writes by a thread before<br>or during a synchronized block are made visible in a <strong>predictable</strong> manner to<br>other threads which synchronize on the <strong>same monitor</strong>.<br>不是同一个 monitor 的, 没有保证.<br>特别地, <code>synchronized (new Object()) {}</code> 可以被认为是毫无用处.<br>如何 “predictable” 在后面具体描述.</li>
<li>After we <strong>exit a synchronized block</strong>, we <strong>release the monitor</strong>.</li>
<li>Before we can <strong>enter a synchronized block</strong>, we <strong>acquire the monitor</strong>.</li>
<li>A thread is said to <strong>own the intrinsic lock</strong> between the time it has<br>acquired the lock and released the lock. As long as a thread owns an intrinsic lock,<br>no other thread can acquire the same lock.<br>The other thread will <strong>block</strong> when it attempts to acquire the lock.<br>(互斥 (mutex) 能力)</li>
<li>参考 ‘Java 内存模型保证成立的 “HB 关系”‘ 部分的第一条和第二条; 由于存在这样的 HB 关系,<br>Java MM 实际上保证了:<br>Any memory operations which were visible to a thread before exiting a synchronized block are visible to any thread after it enters a synchronized block protected by the <strong>same monitor</strong>;<br>为什么:<br>All the memory operations happen before the release (被第一条保证, 这里没有跨线程),<br>and the release happens before the acquire(被第二条保证, 这里跨了线程).</li>
</ul>
<p>C# 定义了 <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/acquire-and-release-semantics" target="_blank" rel="external">Acquire Semantics 和 Release Semantics</a>, </p>
<ul>
<li>An operation has <strong>release semantics</strong> if other processors will see every preceding operation’s effect before the effect of the operation itself</li>
<li>An operation has <strong>acquire semantics</strong> if other processors will always see its effect before any subsequent operation’s effect. </li>
</ul>
<p>这和前面提到的 Java 的 monitor 的 acquire 和 release 是一样的.<br>C# 是通过详细地定义 release 和 acquire 操作而不是通过 HB rule 来解释 <code>volatile</code>, <code>lock() {}</code><br>等同步工具的能力的. Java 主要通过 HB rule. 这两种渠道都是较为常见的, 都要有所了解.</p>
<h3 id="volatile-和-synchronized-的经典案例-“Double-Checked-Locking-is-Broken”"><a href="#volatile-和-synchronized-的经典案例-“Double-Checked-Locking-is-Broken”" class="headerlink" title="volatile 和 synchronized 的经典案例: “Double-Checked Locking is Broken”"></a><code>volatile</code> 和 <code>synchronized</code> 的经典案例: “Double-Checked Locking is Broken”</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123; </div><div class="line">    <span class="keyword">private</span> Helper helper = <span class="keyword">null</span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> Helper <span class="title">getHelper</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (helper == <span class="keyword">null</span>) &#123; </div><div class="line">            <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (helper == <span class="keyword">null</span>) </div><div class="line">                    helper = <span class="keyword">new</span> Helper();</div><div class="line">            &#125;</div><div class="line">        &#125;    </div><div class="line">        <span class="keyword">return</span> helper;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// other functions and members...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果 <code>helper</code> 没有 <code>volatile</code> 修饰, <strong>这段代码是错误的</strong>. 因为读取到 helper 不为空时,<br><strong>构造函数 Helper() 未必执行完</strong>, 其他线程有可能读到脏状态的对象.<br>除了添加 <code>volatile</code>, 也可以把整个方法变为 <code>synchronized</code>. </p>
<p>这段代码的意图是让 helper 对象对外可见, 这被称为 “发布问题”;<br>由于代码没有使用正确的同步机制发布 helper, 这个现象被成为 “不正确的发布”.<br>(更多见 “可见性, 发布和逸出” 笔记)</p>
<p>详细讨论见 <a href="http://www.cs.umd.edu/~pugh/java/memoryModel/DoubleCheckedLocking.html" target="_blank" rel="external">The “Double-Checked Locking is Broken” Declaration</a>;<br>里面更详细地讨论了种种看似聪明但不 work 的 “fix 方案”.</p>
<p>Java 语言的延迟初始化的推荐写法:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HelperHolder</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Helper helper = <span class="keyword">new</span> Helper();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Helper <span class="title">getHelper</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> HelperHolder.helper;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="什么同步都不做-最低安全性-out-of-thin-air-safety"><a href="#什么同步都不做-最低安全性-out-of-thin-air-safety" class="headerlink" title="什么同步都不做? 最低安全性 (out-of-thin-air safety)"></a>什么同步都不做? 最低安全性 (out-of-thin-air safety)</h2><p>当线程在没有同步机制的情况下读取变量, 可能会得到一个 ‘失效的’ (stale) 值;<br>但是这个值一定是 <strong>被之前某个线程设置的值</strong>, 而不是一个随机的值.<br>一般变量的读取和写入都是 ‘原子操作’, 所以有 ‘最低安全性’;<br>非 <code>volatile</code> 类型的 64bit 变量的读写 <strong>未必有 ‘最低安全性’</strong>,<br>因为 java 内存模型允许它被拆分为两个 32bit 的操作.</p>
<p>Java 的 “最低安全性” 事实上已经是是相当强的保证了; C/C++ 没有类似的保证,<br>读取到 undefined 的值完全是正常的, 符合语言标准的.</p>
<h2 id="“piggybacking”-捎带-利用库提供的同步能力-happens-before-性质-实现需要的-visibility-性质"><a href="#“piggybacking”-捎带-利用库提供的同步能力-happens-before-性质-实现需要的-visibility-性质" class="headerlink" title="“piggybacking” (捎带); 利用库提供的同步能力 (happens-before 性质) 实现需要的 visibility 性质"></a>“piggybacking” (捎带); 利用库提供的同步能力 (happens-before 性质) 实现需要的 visibility 性质</h2><p>概念: 参考前文的 [Java 内存模型保证成立的 “HB 关系”], 利用已有的工具 (<code>volatile</code> 等) 已有的<br>happens-before 性质, 加上 “Program order rule”, 保证代码有满足需要的 visibility 性质. </p>
<p>通常来说, 这是为了榨干性能而使用的技术, 不应该随便使用;<br>大部分非关键路径的代码用了这个办法反而使得代码晦涩难懂, 毫无意义.</p>
<p>可以利用的库以及它们拥有的 happens-before 性质 (见 “Java Concurrency in Practice”):</p>
<ul>
<li>线程安全容器: Placing an item in a thread‐safe collection happens‐before another thread retrieves that item from the<br>collection;</li>
<li><code>CountDownLatch</code>: Counting down on a CountDownLatch happens‐before a thread returns from await on that latch;</li>
<li><code>Semaphore</code>: Releasing a permit to a Semaphore happens‐before acquiring a permit from that same Semaphore;</li>
<li><code>Future</code>: Actions taken by the task represented by a Future happens‐before another thread successfully returns from Future.get;</li>
<li><code>Runnable</code>: Submitting a Runnable or Callable to an Executor happens‐before the task begins execution;</li>
<li><code>CyclicBarrier</code> or <code>Exchanger</code>: A thread arriving at a CyclicBarrier or Exchanger happens‐before<br>the other threads are released from that same barrier or exchange point.<br>If CyclicBarrier uses a barrier action, arriving at the barrier happens‐before<br>the barrier action, which in turn happens‐before threads are released from the barrier.</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="Shuhan 同学" />
            
              <p class="site-author-name" itemprop="name">Shuhan 同学</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Shuhan 同学</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.3.9</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Gemini</a> v6.1.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.1.0"></script>



  



	





  





  










  





  

  

  

  

  
  

  

  

  

  

</body>
</html>
